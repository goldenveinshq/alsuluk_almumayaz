<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุธุงู ุฑุตุฏ ุงูุณููู ุงููููุฒ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
   
    <!-- Google Fonts - Tajawal -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- SheetJS for Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
        }
        
        .degree-6 {
            background-color: #fde047;
            border-right: 4px solid #facc15;
        }
        
        .degree-4 {
            background-color: #86efac;
            border-right: 4px solid #22c55e;
        }
        
        .degree-2 {
            background-color: #bfdbfe;
            border-right: 4px solid #3b82f6;
        }
        
        .degree-other {
            background-color: #e9d5ff;
            border-right: 4px solid #a855f7;
        }
        
        .selected-degree {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
            transform: scale(1.02);
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                margin: 0;
                padding: 20px;
            }
        }
        
        .sticky-sidebar {
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
        
        .sticky-sidebar::-webkit-scrollbar {
            width: 6px;
        }
        
        .sticky-sidebar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .sticky-sidebar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        .sticky-sidebar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: fadeIn 0.3s ease-in;
        }
        
        .close-modal {
            color: #aaa;
            float: left;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .close-modal:hover,
        .close-modal:focus {
            color: #000;
        }
        
        .cart-icon {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .cart-icon:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .cart-icon svg {
            width: 24px;
            height: 24px;
        }
        
        /* โจ NEW: ุฃููุงุท ุงูุงุฎุชูุงุฑ ุงููุชุนุฏุฏ ููุทูุงุจ */
        .multi-select-container {
            max-height: 250px;
            overflow-y: auto;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 10px;
            background: #f9fafb;
        }
        
        .multi-select-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .multi-select-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .student-checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        
        .student-checkbox-item:hover {
            background: #eff6ff;
            border-color: #3b82f6;
        }
        
        .student-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-left: 10px;
            cursor: pointer;
        }
        
        .student-checkbox-item.selected {
            background: #dbeafe;
            border-color: #3b82f6;
        }
        
        .selected-count-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #3b82f6;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        /* โจ NEW: ููุท ุนูุงูุฉ ุงููุฌูุฉ ููุทูุงุจ ุงููุชููุฒูู (20+ ุฏุฑุฌุฉ) */
        .star-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* โจ NEW: ุฃููุงุท ููุชุฑ ุงูุชุงุฑูุฎ */
        .date-filter-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .date-filter-container input[type="date"] {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-family: 'Tajawal', sans-serif;
        }
        
        .date-filter-container input[type="date"]:focus {
            border-color: #3b82f6;
            outline: none;
        }

    </style>
</head>
<body class="bg-gray-50">
    
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-blue-700 text-white py-6 shadow-lg no-print">
        <div class="container mx-auto px-4 max-w-7xl">
            <div class="text-center">
                <h1 class="text-4xl font-bold mb-2">๐ ูุธุงู ุฑุตุฏ ุงูุณููู ุงููููุฒ ๐</h1>
ุฅุฏุงุฑุฉ ูุชูุซูู ุงูุณููููุงุช ุงููููุฒุฉ ููุทูุงุจ - ููู ููุงุนุฏ ุงูุณููู ูุงูููุงุธุจุฉ 1447ูู
<span id="appVersionBadge" style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-right: 10px;">v1.0.4</span>
                <div class="mt-3 flex justify-center gap-4">
                    <button onclick="showInfographicModal()" class="bg-white text-blue-600 px-6 py-2 rounded-lg font-semibold hover:bg-blue-50 transition-all flex items-center gap-2">
                        <span>๐</span>
                        <span>ุงูููุฌุฑุงููู ุงูุณููู ุงููููุฒ</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        
        <!-- Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <!-- Main Content Area (3 columns) -->
            <div class="lg:col-span-3 space-y-6">
                
                <!-- Section 1: Import Students from Excel -->
                <section class="bg-white rounded-xl shadow-md p-6 no-print fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span>๐ฅ</span>
                        <span>ุงุณุชูุฑุงุฏ ุจูุงูุงุช ุงูุทูุงุจ ูู ูุธุงู ููุฑ</span>
                    </h2>
                    
                    <div class="bg-blue-50 border-r-4 border-blue-500 p-4 mb-4">
                        <p class="text-sm text-blue-800">
                            <strong>ููุงุญุธุฉ:</strong> ูุฌุจ ุฃู ูุญุชูู ููู Excel ุนูู ุงูุฃุนูุฏุฉ ุงูุชุงููุฉ: 
                            (ุงุณู ุงูุทุงูุจุ ุงูุตูุ ุงููุตูุ ุฑูู ุงูุทุงูุจุ ุฌูุงู ููู ุงูุฃูุฑ)
                        </p>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
                        <input type="file" id="excelFile" accept=".xlsx, .xls" 
                               class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                        <button onclick="importStudentsFromExcel()" 
                                class="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all shadow-md hover:shadow-lg">
                            ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช
                        </button>
                    </div>
                    
                    <div id="importStatus" class="mt-4 hidden"></div>
                </section>

                <!-- Section 2: Record Distinguished Behavior -->
                <section class="bg-white rounded-xl shadow-md p-6 fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <span>โญ</span>
                        <span>ุฑุตุฏ ุงูุณููู ุงููููุฒ</span>
                    </h2>
                    
                    <!-- โจ NEW: School Name + School Type in same row -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <!-- School Name Input -->
                        <div class="md:col-span-2">
                            <label class="block text-gray-700 font-semibold mb-2">ุงุณู ุงููุฏุฑุณุฉ:</label>
                            <input type="text" id="schoolNameInput" placeholder="ุฃุฏุฎู ุงุณู ุงููุฏุฑุณุฉ" 
                                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                        </div>
                        
                        <!-- โจ NEW: School Type (Boys/Girls) -->
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">ููุน ุงููุฏุฑุณุฉ:</label>
                            <select id="schoolTypeSelect" onchange="onSchoolTypeChange()"
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none bg-white">
                                <option value="boys">ุจููู ๐ฆ</option>
                                <option value="girls">ุจูุงุช ๐ง</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Class Selection -->
                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-2">ุงูุตู ูุงููุตู:</label>
                        <select id="classSelect" onchange="loadStudents()" 
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                            <option value="">-- ุงุฎุชุฑ ุงูุตู ูุงููุตู --</option>
                        </select>
                    </div>
                    
                    <!-- โจ MODIFIED: Student Selection with Multi-Select Toggle -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-gray-700 font-semibold" id="studentSelectLabel">ุงุณู ุงูุทุงูุจ:</label>
                            
                            <!-- โจ NEW: Multi-Select Toggle Button -->
                            <button type="button" onclick="toggleMultiSelectMode()" id="multiSelectToggle"
                                    class="text-sm bg-purple-100 text-purple-700 px-4 py-2 rounded-lg hover:bg-purple-200 transition-all flex items-center gap-2">
                                <span id="multiSelectIcon">โ</span>
                                <span id="multiSelectText">ุชุญุฏูุฏ ูุชุนุฏุฏ</span>
                            </button>
                        </div>
                        
                        <!-- Single Select Mode (Default) -->
                        <div id="singleSelectContainer">
                            <select id="studentSelect" 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                                <option value="">-- ุงุฎุชุฑ ุงูุทุงูุจ --</option>
                            </select>
                        </div>
                        
                        <!-- โจ NEW: Multi Select Mode (Hidden by default) -->
                        <div id="multiSelectContainer" class="hidden">
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex gap-2">
                                    <button type="button" onclick="selectAllStudents()" 
                                            class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded hover:bg-green-200">
                                        ุชุญุฏูุฏ ุงููู
                                    </button>
                                    <button type="button" onclick="deselectAllStudents()" 
                                            class="text-xs bg-red-100 text-red-700 px-3 py-1 rounded hover:bg-red-200">
                                        ุฅูุบุงุก ุงููู
                                    </button>
                                </div>
                                <span id="selectedCountBadge" class="selected-count-badge">0 ูุญุฏุฏ</span>
                            </div>
                            <div id="studentsCheckboxList" class="multi-select-container">
                                <!-- Will be populated by JavaScript -->
                                <p class="text-gray-500 text-center py-4">ุงุฎุชุฑ ุงูุตู ุฃููุงู</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Behavior Degree Selection -->
                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-3">ุงุฎุชุฑ ุฏุฑุฌุฉ ุงูุณููู:</label>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                            <!-- 6 Points -->
                            <div onclick="selectDegree(6)" id="degree-6" 
                                 class="degree-6 p-4 rounded-lg cursor-pointer hover:shadow-lg transition-all text-center">
                                <div class="text-3xl font-bold text-yellow-800">6</div>
                                <div class="text-sm font-semibold text-yellow-700">ุฏุฑุฌุงุช</div>
                                <div class="text-xs text-yellow-600 mt-1">ุฃุนูู ูุณุชูู</div>
                            </div>
                            
                            <!-- 4 Points -->
                            <div onclick="selectDegree(4)" id="degree-4" 
                                 class="degree-4 p-4 rounded-lg cursor-pointer hover:shadow-lg transition-all text-center">
                                <div class="text-3xl font-bold text-green-800">4</div>
                                <div class="text-sm font-semibold text-green-700">ุฏุฑุฌุงุช</div>
                                <div class="text-xs text-green-600 mt-1">ูุณุชูู ูุชูุฏู</div>
                            </div>
                            
                            <!-- 2 Points -->
                            <div onclick="selectDegree(2)" id="degree-2" 
                                 class="degree-2 p-4 rounded-lg cursor-pointer hover:shadow-lg transition-all text-center">
                                <div class="text-3xl font-bold text-blue-800">2</div>
                                <div class="text-sm font-semibold text-blue-700">ุฏุฑุฌุชุงู</div>
                                <div class="text-xs text-blue-600 mt-1">ูุณุชูู ุฌูุฏ</div>
                            </div>
                            
                            <!-- Other (Custom) -->
                            <div onclick="selectDegree('other')" id="degree-other" 
                                 class="degree-other p-4 rounded-lg cursor-pointer hover:shadow-lg transition-all text-center">
                                <div class="text-3xl font-bold text-purple-800">ุ</div>
                                <div class="text-sm font-semibold text-purple-700">ุฃุฎุฑู</div>
                                <div class="text-xs text-purple-600 mt-1">ุญุณุจ ุงูุชูุตูุฉ</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Behavior Type Selection -->
                    <div class="mb-6" id="behaviorTypeContainer" style="display: none;">
                        <label class="block text-gray-700 font-semibold mb-2">ููุน ุงูุณููู ุงููููุฒ:</label>
                        <select id="behaviorType" 
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                            <option value="">-- ุงุฎุชุฑ ููุน ุงูุณููู --</option>
                        </select>
                    </div>
                    
                    <!-- Custom Points Input (for "Other" option) -->
                    <div class="mb-6" id="customPointsContainer" style="display: none;">
                        <label class="block text-gray-700 font-semibold mb-2">ุนุฏุฏ ุงูุฏุฑุฌุงุช (ูุง ูุฒูุฏ ุนู 6):</label>
                        <input type="number" id="customPoints" min="1" max="6" placeholder="ุฃุฏุฎู ุนุฏุฏ ุงูุฏุฑุฌุงุช" 
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                    </div>
                    
                    <!-- Additional Notes -->
                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-2">ุฅุถุงูุฉ ูุตู ุงูุดุงูุฏ ุฃู ุงู ููุงุญุธุงุช ุฅุถุงููุฉ (ุงุฎุชูุงุฑู):</label>
                        <textarea id="noteInput" rows="3" placeholder="ุฃุถู ููุน ุฃู ูุตู ููุดุงูุฏ ุนูู ุงูุณููู ุฃู ุฃู ููุงุญุธุงุช ุฅุถุงููุฉ..." 
                                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none resize-none"></textarea>
                    </div>
                    
                    <!-- โจ MODIFIED: Recorder Name with Gender-aware options -->
                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-2">ุงุณู ุงูุฑุงุตุฏ:</label>
                        <select id="senderSelect" 
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                            <option value="ุดุคูู ุงูุทูุงุจ">ุดุคูู ุงูุทูุงุจ</option>
                            <option value="ุงูููุฌู ุงูุทูุงุจู" id="optionCounselor">ุงูููุฌู ุงูุทูุงุจู</option>
                            <option value="ุงูุฅุฏุงุฑุฉ ุงููุฏุฑุณูุฉ">ุงูุฅุฏุงุฑุฉ ุงููุฏุฑุณูุฉ</option>
                            <option value="ุงููุฑุดุฏ ุงูุทูุงุจู" id="optionAdvisor">ุงููุฑุดุฏ ุงูุทูุงุจู</option>
                            <option value="custom">ุฃุฎุฑู (ุญุฏุฏ)</option>
                        </select>
                        <input type="text" id="customSenderInput" placeholder="ุฃุฏุฎู ุงุณู ุงูุฑุงุตุฏ" 
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none mt-2 hidden">
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex flex-wrap gap-3">
                        <button onclick="saveOperation()" 
                                class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition-all shadow-md hover:shadow-lg">
                            ๐พ ุญูุธ ุงูุณููู ุงููููุฒ
                        </button>
                        <button onclick="saveAndPrint()" 
                                class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all shadow-md hover:shadow-lg">
                            ๐จ๏ธ ุญูุธ ูุทุจุงุนุฉ
                        </button>
                        <button onclick="sendWhatsAppDirect()"
                                class="flex-1 bg-emerald-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-emerald-700 transition-all shadow-md hover:shadow-lg">
                            ๐ฑ ุฅุฑุณุงู ูุงุชุณุงุจ
                        </button>
                    </div>
                </section>

                <!-- Section 3: Statistics Dashboard -->
                <section class="bg-white rounded-xl shadow-md p-6 fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <span>๐</span>
                        <span>ููุญุฉ ุงูุฅุญุตุงุฆูุงุช</span>
                    </h2>
                    
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 rounded-lg shadow-md">
                            <div class="text-3xl font-bold" id="totalBehaviors">0</div>
                            <div class="text-sm opacity-90">ุฅุฌูุงูู ุงูุณููููุงุช</div>
                        </div>
                        <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-4 rounded-lg shadow-md">
                            <div class="text-3xl font-bold" id="totalStudents">0</div>
                            <!-- โจ MODIFIED: Dynamic text based on school type -->
                            <div class="text-sm opacity-90" id="totalStudentsLabel">ุนุฏุฏ ุงูุทูุงุจ ุงููุชููุฒูู</div>
                        </div>
                        <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-white p-4 rounded-lg shadow-md">
                            <div class="text-3xl font-bold" id="totalPoints">0</div>
                            <div class="text-sm opacity-90">ุฅุฌูุงูู ุงูููุงุท ุงูููุชุณุจุฉ</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-4 rounded-lg shadow-md">
                            <div class="text-3xl font-bold" id="avgBehaviors">0</div>
                            <div class="text-sm opacity-90">ูุชูุณุท ุงูุณููููุงุช</div>
                        </div>
                    </div>
                    
                    <!-- โจ NEW: Star Achievement Info Box -->
                    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-300 rounded-lg p-4 mb-6">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">โญ</span>
                            <div>
                                <h4 class="font-bold text-yellow-800">ุดุงุฑุฉ ุงูุชููุฒ ุงูุฐูุจูุฉ</h4>
                                <p class="text-sm text-yellow-700">
                                    <span id="starStudentsLabel">ุงูุทูุงุจ</span> ุงูุฐูู ูุญุตููู ุนูู <strong>20 ุฏุฑุฌุฉ ุฃู ุฃูุซุฑ</strong> ูุญุตููู ุนูู ุดุงุฑุฉ โญ ุงูุชููุฒ
                                </p>
                            </div>
                            <div class="mr-auto">
                                <span class="text-2xl font-bold text-yellow-600" id="starStudentsCount">0</span>
                                <span class="text-sm text-yellow-600 block" id="starStudentsText">ูุชููุฒ</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <h3 class="font-semibold text-gray-700 mb-3 text-center">ุชูุฒูุน ุงูุณููููุงุช ุญุณุจ ุงูุฏุฑุฌุฉ</h3>
                            <div class="bg-gray-50 p-4 rounded-lg" style="height: 300px;">
                                <canvas id="behaviorsByDegreeChart"></canvas>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-700 mb-3 text-center">ุฃุนูู ุงููุตูู ุชููุฒุงู</h3>
                            <div class="bg-gray-50 p-4 rounded-lg" style="height: 300px;">
                                <canvas id="behaviorsByClassChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tables -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-semibold text-gray-700 mb-3">ุงูุณููููุงุช ุงูุฃูุซุฑ ุดููุนุงู</h3>
                            <div class="overflow-x-auto bg-gray-50 rounded-lg">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="py-2 px-3 text-right">ุงูุณููู</th>
                                            <th class="py-2 px-3 text-center">ุงูุนุฏุฏ</th>
                                            <th class="py-2 px-3 text-center">ุงููุณุจุฉ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="commonBehaviorsList">
                                        <tr>
                                            <td colspan="3" class="py-2 px-3 text-center text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div>
                            <!-- โจ MODIFIED: Dynamic header based on school type -->
                            <h3 class="font-semibold text-gray-700 mb-3" id="topStudentsTitle">ุงูุทูุงุจ ุงูุฃูุซุฑ ุชููุฒุงู</h3>
                            <div class="overflow-x-auto bg-gray-50 rounded-lg">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <!-- โจ MODIFIED: Dynamic column header -->
                                            <th class="py-2 px-3 text-right" id="studentColumnHeader">ุงูุทุงูุจ</th>
                                            <th class="py-2 px-3 text-right">ุงููุตู</th>
                                            <th class="py-2 px-3 text-center">ุงูุนุฏุฏ</th>
                                            <th class="py-2 px-3 text-center">ุงูููุงุท</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topStudentsList">
                                        <tr>
                                            <td colspan="4" class="py-2 px-3 text-center text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Section 4: Reports -->
                <section class="bg-white rounded-xl shadow-md p-6 no-print fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <span>๐</span>
                        <span>ุงูุชูุงุฑูุฑ ูุงูุทุจุงุนุฉ</span>
                    </h2>
                    
                    <!-- โจ NEW: Date Filter Section -->
                    <div class="date-filter-container mb-6">
                        <div class="flex items-center gap-2">
                            <span class="text-gray-600 font-semibold">๐ ููุชุฑุฉ ุจุงูุชุงุฑูุฎ:</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-gray-600">ูู:</label>
                            <input type="date" id="filterDateFrom" class="text-sm">
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-gray-600">ุฅูู:</label>
                            <input type="date" id="filterDateTo" class="text-sm">
                        </div>
                        <button onclick="applyDateFilter()" 
                                class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600 transition-all">
                            ุชุทุจูู ุงูููุชุฑ
                        </button>
                        <button onclick="clearDateFilter()" 
                                class="bg-gray-400 text-white px-4 py-2 rounded-lg text-sm hover:bg-gray-500 transition-all">
                            ุฅูุบุงุก ุงูููุชุฑ
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <button onclick="displayOperations()" 
                                class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                            <span>๐</span>
                            <span>ุนุฑุถ ุฌููุน ุงูุณููููุงุช</span>
                        </button>
                        
                        <button onclick="showFilterByStudentDialog()" 
                                class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                            <span>๐ค</span>
                            <!-- โจ MODIFIED: Dynamic text -->
                            <span id="btnStudentReport">ุชูุฑูุฑ ุทุงูุจ ูุญุฏุฏ</span>
                        </button>
                        
                        <button onclick="showFilterByClassDialog()" 
                                class="bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700 transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                            <span>๐ซ</span>
                            <span>ุชูุฑูุฑ ูุตู ูุญุฏุฏ</span>
                        </button>
                        
                        <!-- โจ NEW: Star Students Report Button -->
                        <button onclick="showStarStudentsReport()" 
                                class="bg-yellow-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-yellow-600 transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                            <span>โญ</span>
                            <span id="btnStarReport">ุชูุฑูุฑ ุงููุชููุฒูู (20+ ุฏุฑุฌุฉ)</span>
                        </button>
                        
                        <button onclick="printAllOperations()" 
                                class="bg-orange-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-orange-700 transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                            <span>๐จ๏ธ</span>
                            <span>ุทุจุงุนุฉ ุชูุฑูุฑ ุดุงูู</span>
                        </button>
                        
                        <button onclick="createBackup()" 
                                class="bg-teal-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-teal-700 transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                            <span>๐พ</span>
                            <span>ูุณุฎุฉ ุงุญุชูุงุทูุฉ</span>
                        </button>
                        
                        <button onclick="showRestoreBackupDialog()" 
                                class="bg-pink-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-pink-700 transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                            <span>๐ฅ</span>
                            <span>ุงุณุชุนุงุฏุฉ ูุณุฎุฉ</span>
                        </button>
                    </div>
                </section>

                <!-- Operations Display Container -->
                <section id="operationsContainer" class="bg-white rounded-xl shadow-md p-6 hidden fade-in">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800" id="operationsTitle">ุงูุณููููุงุช ุงููุณุฌูุฉ</h2>
                        <button onclick="closeOperations()" 
                                class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all">
                            ุฅุบูุงู
                        </button>
                    </div>
                    
                    <!-- โจ NEW: Active Date Filter Indicator -->
<div id="activeDateFilterBadge" class="hidden flex items-center gap-2 bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 mt-2">
    <span id="activeDateFilterText" class="text-blue-700 text-sm"></span>
    <button onclick="printFilteredPeriod()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700" title="ุทุจุงุนุฉ ุงููุชุฑุฉ">
        ๐จ๏ธ ุทุจุงุนุฉ
    </button>
    <button onclick="clearDateFilter()" class="text-red-600 hover:text-red-800 text-sm" title="ุฅูุบุงุก ุงูููุชุฑ">
        โ๏ธ
    </button>
</div>

                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm" id="operationsTable">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="py-3 px-3 text-right">ุงูุชุงุฑูุฎ</th>
                                    <th class="py-3 px-3 text-right">ุงููุตู</th>
                                    <!-- โจ MODIFIED: Dynamic column header -->
                                    <th class="py-3 px-3 text-right" id="operationsStudentHeader">ุงูุทุงูุจ</th>
                                    <th class="py-3 px-3 text-right">ุงูุณููู</th>
                                    <th class="py-3 px-3 text-center">ุงูุฏุฑุฌุฉ</th>
                                    <th class="py-3 px-3 text-right">ุงูุฑุงุตุฏ</th>
                                    <th class="py-3 px-2 text-right" id="operationsActionsHeader">ุงูุฅุฌุฑุงุกุงุช</th>
                                </tr>
                            </thead>
                            <tbody id="operationsTableBody">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 flex justify-between items-center">
                        <div class="text-gray-600">
                            <strong>ุงูุฅุฌูุงูู:</strong> <span id="operationsCount">0</span> ุณููู ูููุฒ
                        </div>
                        <button onclick="clearOperations()" 
                                class="bg-red-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-red-700 transition-all">
                            ๐๏ธ ูุณุญ ุฌููุน ุงูุณุฌูุงุช
                        </button>
                    </div>
                </section>

            </div>
            
            <!-- Sidebar (1 column) -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-md p-5 sticky-sidebar">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span>๐</span>
                        <span>ุฏููู ุงูุณููู ุงููููุฒ</span>
                    </h3>
                    
                    <!-- 6 Points Behaviors -->
                    <div class="mb-4">
                        <div class="bg-yellow-100 px-3 py-2 rounded-t-lg border-b-2 border-yellow-500">
                            <h4 class="font-bold text-yellow-800 text-sm">6 ุฏุฑุฌุงุช - ุงููุณุชูู ุงูุฃุนูู</h4>
                        </div>
                        <div class="bg-yellow-50 p-3 rounded-b-lg">
                            <ul class="text-xs space-y-1 text-gray-700">
                                <!-- โจ MODIFIED: Dynamic text based on gender -->
                                <li id="guide6-1">โข ุงูุถุจุงุท ุงูุทุงูุจ ูุนุฏู ุบูุงุจู ุจุฏูู ุนุฐุฑ</li>
                                <li>โข ุงููุดุงุฑูุฉ ูู ุงูุฎุฏูุฉ ุงููุฌุชูุนูุฉ</li>
                                <li>โข ุชูุฏูู ูุนุงููุฉ ุญูุงุฑูุฉ</li>
                                <li>โข ุงููุดุงุฑูุฉ ูู ุญููุฉ ุชูุนูุฉ</li>
                                <li>โข ุนุฑุถ ุชุฌุงุฑุจ ุดุฎุตูุฉ ูุงุฌุญุฉ</li>
                                <li>โข ุงูุงูุชุญุงู ุจุจุฑูุงูุฌ ุฃู ุฏูุฑุฉ</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- 4 Points Behaviors -->
                    <div class="mb-4">
                        <div class="bg-green-100 px-3 py-2 rounded-t-lg border-b-2 border-green-500">
                            <h4 class="font-bold text-green-800 text-sm">4 ุฏุฑุฌุงุช - ุงููุณุชูู ุงููุชูุฏู</h4>
                        </div>
                        <div class="bg-green-50 p-3 rounded-b-lg">
                            <ul class="text-xs space-y-1 text-gray-700">
                                <li>โข ุฃูุดุทุฉ ููุงุฑุงุช ุงูุงุชุตุงู</li>
                                <li>โข ููุงุฑุงุช ุงูููุงุฏุฉ ูุงููุณุคูููุฉ</li>
                                <li>โข ุฃูุดุทุฉ ุงูููุงุฑุงุช ุงูุฑูููุฉ</li>
                                <li>โข ุฃูุดุทุฉ ููุงุฑุฉ ุฅุฏุงุฑุฉ ุงูููุช</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- 2 Points Behaviors -->
                    <div class="mb-4">
                        <div class="bg-blue-100 px-3 py-2 rounded-t-lg border-b-2 border-blue-500">
                            <h4 class="font-bold text-blue-800 text-sm">ุฏุฑุฌุชุงู - ุงููุณุชูู ุงูุฌูุฏ</h4>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-b-lg">
                            <ul class="text-xs space-y-1 text-gray-700">
                                <li>โข ูุชุงุจุฉ ุฑุณุงูุฉ ุดูุฑ</li>
                                <li>โข ุงููุดุงุฑูุฉ ูู ุงูุฅุฐุงุนุฉ</li>
                                <li>โข ุชูุฏูู ููุชุฑุญ ูููุฌุชูุน ุงููุฏุฑุณู</li>
                                <li>โข ุงูุชุนุงูู ูุน ุงูุฒููุงุก ูุงููุนูููู</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Other -->
                    <div class="mb-4">
                        <div class="bg-purple-100 px-3 py-2 rounded-t-lg border-b-2 border-purple-500">
                            <h4 class="font-bold text-purple-800 text-sm">ุฃุฎุฑู - ุญุณุจ ุงูุชูุตูุฉ</h4>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-b-lg">
                            <p class="text-xs text-gray-700">ุจูุงุกู ุนูู ุชูุตูุฉ ูุฌูุฉ ุงูุชูุฌูู ุงูุทูุงุจู (ุญุชู 6 ุฏุฑุฌุงุช)</p>
                        </div>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="mt-6 pt-4 border-t-2 border-gray-200">
                        <h4 class="font-bold text-gray-800 text-sm mb-3">๐ ุฅุญุตุงุฆูุงุช ุณุฑูุนุฉ</h4>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between">
                                <span class="text-gray-600">ุณููููุงุช ูุณุฌูุฉ:</span>
                                <span class="font-bold text-blue-600" id="sidebarTotal">0</span>
                            </div>
                            <div class="flex justify-between">
                                <!-- โจ MODIFIED: Dynamic text -->
                                <span class="text-gray-600" id="sidebarStudentsLabel">ุทูุงุจ ูุชููุฒูู:</span>
                                <span class="font-bold text-green-600" id="sidebarStudents">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">ููุงุท ููุชุณุจุฉ:</span>
                                <span class="font-bold text-yellow-600" id="sidebarPoints">0</span>
                            </div>
                            <!-- โจ NEW: Star students count in sidebar -->
                            <div class="flex justify-between items-center pt-2 border-t border-gray-200">
                                <span class="text-gray-600">โญ ุญุงุตููู ุนูู 20+:</span>
                                <span class="font-bold text-orange-500" id="sidebarStarCount">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

<!-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ -->
<!--                    Modal: Privacy Policy                        -->
<!-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ -->
<div id="privacyModal" class="modal">
    <div class="modal-content" style="max-width: 800px; max-height: 85vh; overflow-y: auto;">
        <span class="close-modal" onclick="closePrivacyModal()">&times;</span>
        
        <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">๐ ุณูุงุณุฉ ุงูุฎุตูุตูุฉ ูุฅุฎูุงุก ุงููุณุคูููุฉ</h2>
            <p class="text-sm text-gray-500">ุจุฑูุงูุฌ ุฑุตุฏ ุงูุณููู ุงููููุฒ ููุทูุงุจ</p>
        </div>
        
        <div class="bg-green-50 border-r-4 border-green-500 p-4 mb-4 rounded-lg">
            <h3 class="font-bold text-green-800 mb-2">๐ ุงูุฎุตูุตูุฉ ูุญูุงูุฉ ุงูุจูุงูุงุช</h3>
            <ul class="text-sm text-green-700 space-y-1">
                <li>โข ุฌููุน ุงูุจูุงูุงุช ุชูุญูุธ <strong>ูุญููุงู ุนูู ุฌูุงุฒู ููุท</strong></li>
                <li>โข <strong>ูุง ูุชู ุฅุฑุณุงู ุฃู ุจูุงูุงุช</strong> ุฅูู ุฎูุงุฏู ุฎุงุฑุฌูุฉ</li>
                <li>โข <strong>ูุง ูุฌูุน ุฃู ูุฎุฒู</strong> ุฃู ูุนูููุงุช ุนู ุงููุณุชุฎุฏููู</li>
                <li>โข ูุณุญ ุจูุงูุงุช ุงููุชุตูุญ ุณูุคุฏู ูููุฏุงู ุงูุจูุงูุงุช ุงููุญููุธุฉ</li>
            </ul>
        </div>
        
        <div class="bg-red-50 border-r-4 border-red-500 p-4 mb-4 rounded-lg">
            <h3 class="font-bold text-red-800 mb-2">โ๏ธ ุฅุฎูุงุก ุงููุณุคูููุฉ</h3>
            <ul class="text-sm text-red-700 space-y-1">
                <li>โข ูุฐุง ุงูุจุฑูุงูุฌ <strong>ูุณุฎุฉ ุชุฌุฑูุจูุฉ</strong> ูุฏ ุชุญุชูู ุนูู ุฃุฎุทุงุก</li>
                <li>โข ูุฌุจ <strong>ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช</strong> ูุจู ุงูุงุนุชูุงุฏ ุงูุฑุณูู</li>
                <li>โข <strong>ูุง ูุชุญูู ูุณุคูููุฉ ููุฏุงู ุงูุจูุงูุงุช</strong> ูุฃู ุณุจุจ</li>
                <li>โข <strong>ูุง ูุชุญูู ูุณุคูููุฉ ุงูุงุณุชุฎุฏุงู ุงูุฎุงุทุฆ</strong> ุฃู ุบูุฑ ุงููุธุงูู</li>
                <li>โข ูุฌุจ ุงูุงุณุชุฎุฏุงู ููู <strong>ุฃุฏูุฉ ูุฃูุธูุฉ ูุฒุงุฑุฉ ุงูุชุนููู</strong></li>
            </ul>
        </div>
        
        <div class="bg-yellow-50 border-r-4 border-yellow-500 p-4 mb-4 rounded-lg">
            <h3 class="font-bold text-yellow-800 mb-2">๐ ุชูุตูุงุช ูุงูุฉ</h3>
            <ul class="text-sm text-yellow-700 space-y-1">
                <li>โข โญ <strong>ุงุญุฑุต ุนูู ุงููุณุฎ ุงูุงุญุชูุงุทู ุงูุฏูุฑู</strong> (ููููุงู ุฃู ุฃุณุจูุนูุงู)</li>
                <li>โข โญ <strong>ุงุทุจุน ุชูุงุฑูุฑ ุดุงููุฉ ุจุดูู ุฏูุฑู</strong> ูุณุฌูุงุช ุงุญุชูุงุทูุฉ</li>
                <li>โข ุฑุงุฌุน ุงูุจูุงูุงุช ูุชุญูู ูู ุงูุญุณุงุจุงุช ูุจู ุงูุงุนุชูุงุฏ</li>
                <li>โข ูุงุฑู ุงููุชุงุฆุฌ ูุน ุงูุณุฌูุงุช ุงูุฑุณููุฉ ูู ูุธุงู ููุฑ</li>
            </ul>
        </div>
        
        <div class="bg-blue-50 border-r-4 border-blue-500 p-4 mb-4 rounded-lg">
            <h3 class="font-bold text-blue-800 mb-2">โ ุงูููุงููุฉ ุนูู ุงูุดุฑูุท</h3>
            <p class="text-sm text-blue-700">
                ุจุงุณุชุฎุฏุงูู ููุฐุง ุงูุจุฑูุงูุฌุ ูุฅูู ุชูุงูู ุนูู ุฌููุน ุจููุฏ ุณูุงุณุฉ ุงูุฎุตูุตูุฉ 
                ูุฅุฎูุงุก ุงููุณุคูููุฉุ ูุชุชุญูู ุงููุณุคูููุฉ ุงููุงููุฉ ุนู ุงูุจูุงูุงุช ูุงุณุชุฎุฏุงููุง.
            </p>
        </div>
        
        <div class="text-center mt-6">
            <button onclick="closePrivacyModal()" 
                    class="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all">
                ูููุช ูุฃูุงูู โ
            </button>
        </div>
        
        <p class="text-center text-xs text-gray-400 mt-4">
            ุขุฎุฑ ุชุญุฏูุซ: ุงูุฅุตุฏุงุฑ 1.0.3
        </p>
    </div>
</div>

<!-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ -->
<!--                         Footer                                  -->
<!-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ -->
<footer class="bg-gray-100 border-t border-gray-200 py-4 mt-8">
    <div class="container mx-auto text-center">
        <button onclick="openPrivacyModal()" 
                class="text-blue-600 hover:text-blue-800 text-sm underline cursor-pointer bg-transparent border-none">
            ๐ ุณูุงุณุฉ ุงูุฎุตูุตูุฉ ูุฅุฎูุงุก ุงููุณุคูููุฉ
        </button>
        <p class="text-xs text-gray-500 mt-2">
            ุจุฑูุงูุฌ ุฑุตุฏ ุงูุณููู ุงููููุฒ - ูุณุฎุฉ ุชุฌุฑูุจูุฉ v1.0.3
        </p>
    </div>
</footer>

    <!-- Modal: Infographic Info -->
    <div id="infographicModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeInfographicModal()">&times;</span>
            
            <div class="text-center mb-6">
                <h2 class="text-3xl font-bold text-blue-600 mb-2">๐ ุงูููุฌุฑุงููู ุงูุณููู ุงููููุฒ</h2>
                <p class="text-gray-600">ุชุตุงููู ุงุญุชุฑุงููุฉ ุชูุถุญ ุฃููุงุน ุงูุณููู ุงููููุฒ ุงููุทููุจุฉ</p>
            </div>
            
            <div class="bg-blue-50 border-r-4 border-blue-500 p-4 mb-6 rounded-lg">
                <p class="text-sm text-blue-800 leading-relaxed">
                    ุชุตุงููู ุงุญุชุฑุงููุฉ ุชูุถุญ ุฃููุงุน ุงูุณููู ุงููููุฒ ุงููุทููุจุฉุ ูุน ุฃูุซูุฉ ุชูุถูุญูุฉ ูุงูุดูุงูุฏ ุงููุทููุจุฉุ 
                    ูุงูุฏูุฑ ุงูุฎุงุต ุจููู ุงูุฃูุฑ ุฃู ุงููุนูู ุฃู ุงููุฏุฑุณุฉ... ุชุณุงุนุฏ ุงูุทูุงุจ ูุงููุนูููู ุนูู ููู ุงููุนุงููุฑ ุจุดูู ุฃูุถู.
                </p>
                <p class="text-xs text-blue-700 mt-2 font-semibold">
                    * ูุชูุงููุฉ ูุน ููุงุฑุณุงุช ุงูุณููู ุงููููุฒ ุงูููุชุฑุญุฉ ุงููุงุฑุฏุฉ ูู ููุงุนุฏ ุงูุณููู ูุงูููุงุธุจุฉ ููุนุงู 1447ูู ุตูุญุฉ 19.
                </p>
            </div>
            
            <div class="bg-white border-2 border-gray-200 rounded-lg p-5 mb-6">
                <h3 class="font-bold text-gray-800 mb-3 text-lg">๐ ูุญุชููุงุช ุงูุจุฑูุดูุฑ:</h3>
                <ul class="space-y-2 text-gray-700">
                    <li class="flex items-start gap-2">
                        <span class="text-green-600 font-bold">โ</span>
                        <span>ุชุตููู ุดุงูู ูุฃููุงุน ุงูุณููู ุงููููุฒ</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-green-600 font-bold">โ</span>
                        <span>ุฃูุซูุฉ ุนูููุฉ ููู ููุน ุณููู</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-green-600 font-bold">โ</span>
                        <span>ุงูุฏุฑุฌุงุช ุงููุฎุตุตุฉ ููู ุณููู</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-green-600 font-bold">โ</span>
                        <span>ูุตุงุฆุญ ููุทูุงุจ ูุชุญููู ุงูุชููุฒ</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-green-600 font-bold">โ</span>
                        <span>ุชุตุงููู ุฌุฐุงุจุฉ ูููููุฉ</span>
                    </li>
                </ul>
            </div>
            
            <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-6">
                <p class="text-sm text-yellow-800">
                    <strong>ููุงุญุธุฉ:</strong> ุฌููุน ูุง ูุฑุฏ ูู ูุฐู ุงูุงูููุฌุฑุงููู ุฃูุซูุฉ ููุชูุถูุญ ููููู ูููุฏุฑุณุฉ ุชุญุฏูุฏ 
                    ุชูุฌูู ุงูุทูุงุจ ูุฃู ุฃูุซูุฉ ุฃุฎุฑู ุชุชูุงุณุจ ูุน ุงููุฑุญูุฉ ุฃู ููุน ุงููุฏุฑุณุฉ ููุฆุฉ ุงูุทูุงุจ.
                </p>
            </div>
            
            <!-- Link Section (Protected) - Hidden by default, controlled by JS -->
            <div class="text-center" id="infographicLinkSection" style="display:none;">
                <a href="#" id="infographicLinkButton" target="_blank" class="cart-icon inline-flex">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/>
                    </svg>
                    <span id="infographicButtonTextDisplay">
                        <!-- Will be set by JavaScript -->
                    </span>
                </a>
            </div>
        </div>
    </div>

    <!-- Modal: Filter by Student -->
    <div id="filterStudentModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeFilterStudentModal()">&times;</span>
            <!-- โจ MODIFIED: Dynamic title -->
            <h2 class="text-2xl font-bold text-gray-800 mb-4" id="filterStudentModalTitle">ุชูุฑูุฑ ุทุงูุจ ูุญุฏุฏ</h2>
            
<!-- Date filter hidden -->
<div class="bg-gray-50 p-4 rounded-lg mb-4" style="display:none;">
                <label class="block text-gray-700 font-semibold mb-2">๐ ููุชุฑุฉ ุจุงูุชุงุฑูุฎ (ุงุฎุชูุงุฑู):</label>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-gray-500">ูู:</label>
                        <input type="date" id="studentReportDateFrom" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">ุฅูู:</label>
                        <input type="date" id="studentReportDateTo" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">ุงุฎุชุฑ ุงููุตู:</label>
                <select id="filterClassSelect" onchange="loadFilterStudents()" 
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                    <option value="">-- ุงุฎุชุฑ ุงููุตู --</option>
                </select>
            </div>
            
            <div class="mb-4">
                <!-- โจ MODIFIED: Dynamic label -->
                <label class="block text-gray-700 font-semibold mb-2" id="filterStudentSelectLabel">ุงุฎุชุฑ ุงูุทุงูุจ:</label>
                <select id="filterStudentSelect" 
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                    <option value="">-- ุงุฎุชุฑ ุงูุทุงูุจ --</option>
                </select>
            </div>
            
            <div class="flex gap-3">
                <button onclick="filterByStudent()" 
                        class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition-all">
                    ุนุฑุถ ุงูุชูุฑูุฑ
                </button>
                <button onclick="printStudentReport()" 
                        class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all">
                    ุทุจุงุนุฉ ุงูุชูุฑูุฑ
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Filter by Class -->
    <div id="filterClassModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeFilterClassModal()">&times;</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ุชูุฑูุฑ ูุตู ูุญุฏุฏ</h2>
            
            <!-- Date filter hidden -->
            <div class="bg-gray-50 p-4 rounded-lg mb-4" style="display:none;">
                <label class="block text-gray-700 font-semibold mb-2">๐ ููุชุฑุฉ ุจุงูุชุงุฑูุฎ (ุงุฎุชูุงุฑู):</label>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-gray-500">ูู:</label>
                        <input type="date" id="classReportDateFrom" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">ุฅูู:</label>
                        <input type="date" id="classReportDateTo" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">ุงุฎุชุฑ ุงููุตู:</label>
                <select id="filterClassOnlySelect" 
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                    <option value="">-- ุงุฎุชุฑ ุงููุตู --</option>
                </select>
            </div>
            
            <div class="flex gap-3">
                <button onclick="filterByClass()" 
                        class="flex-1 bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700 transition-all">
                    ุนุฑุถ ุงูุชูุฑูุฑ
                </button>
                <button onclick="printClassReport()" 
                        class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all">
                    ุทุจุงุนุฉ ุงูุชูุฑูุฑ
                </button>
            </div>
        </div>
    </div>

<!-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ -->
<!--                    Modal: Restore Backup                        -->
<!-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ -->
<div id="restoreBackupDialog" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <span class="close-modal" onclick="closeRestoreBackupDialog()">&times;</span>
        
        <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">๐ฅ ุงุณุชุนุงุฏุฉ ูุณุฎุฉ ุงุญุชูุงุทูุฉ</h2>
        </div>
        
        <!-- ุงุฎุชูุงุฑ ุงูููู -->
        <div class="mb-4">
            <label class="block text-gray-700 font-semibold mb-2">ุงุฎุชุฑ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ:</label>
            <input type="file" id="backupFile" accept=".json" 
                   class="w-full p-3 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 transition-all"
                   onchange="previewBackupFile()">
        </div>
        
        <!-- ูุนุงููุฉ ุงูููู -->
        <div id="backupPreview" class="hidden mb-4 p-4 bg-gray-50 rounded-lg">
            <h4 class="font-bold text-gray-700 mb-2">๐ ูุนูููุงุช ุงูููู:</h4>
            <div id="backupPreviewContent" class="text-sm text-gray-600"></div>
        </div>
        
        <!-- ุทุฑููุฉ ุงูุงุณุชุนุงุฏุฉ -->
        <div class="mb-4">
            <label class="block text-gray-700 font-semibold mb-3">ุทุฑููุฉ ุงูุงุณุชุนุงุฏุฉ:</label>
            
            <!-- ุฎูุงุฑ ุงูุงุณุชุจุฏุงู -->
            <label class="flex items-start p-3 mb-2 border-2 rounded-lg cursor-pointer hover:border-red-300 transition-all restore-option" id="replaceOption">
                <input type="radio" name="restoreMode" value="replace" class="mt-1 ml-3" checked onchange="updateRestoreOptionStyle()">
                <div>
                    <div class="font-bold text-red-600">๐ ุงุณุชุจุฏุงู ูุงูู</div>
                    <div class="text-sm text-gray-500">ุญุฐู ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ ูุงุณุชุจุฏุงููุง ุจุงูููู ุงูุฌุฏูุฏ</div>
                </div>
            </label>
            
            <!-- ุฎูุงุฑ ุงูุฏูุฌ -->
            <label class="flex items-start p-3 border-2 rounded-lg cursor-pointer hover:border-green-300 transition-all restore-option" id="mergeOption">
                <input type="radio" name="restoreMode" value="merge" class="mt-1 ml-3" onchange="updateRestoreOptionStyle()">
                <div>
                    <div class="font-bold text-green-600">โ ุฏูุฌ ุฐูู</div>
                    <div class="text-sm text-gray-500">ุฅุถุงูุฉ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ ููุท ูุน ุชุฌูุจ ุงูุชูุฑุงุฑุงุช</div>
                </div>
            </label>
        </div>
        
        <!-- ุชุญุฐูุฑ -->
        <div id="restoreWarning" class="bg-red-50 border-r-4 border-red-500 p-3 mb-4 rounded">
            <p class="text-sm text-red-700">
                <strong>โ๏ธ ุชุญุฐูุฑ:</strong> ุณูุชู ุญุฐู ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ ูุงุณุชุจุฏุงููุง!
            </p>
        </div>
        
        <!-- ุฃุฒุฑุงุฑ -->
        <div class="flex gap-3 justify-center mt-6">
            <button onclick="closeRestoreBackupDialog()" 
                    class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all">
                ุฅูุบุงุก
            </button>
            <button onclick="restoreBackup()" 
                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all">
                ุชูููุฐ ุงูุงุณุชุนุงุฏุฉ
            </button>
        </div>
    </div>
</div>

    <!-- โจ NEW: Modal for Star Students Report -->
    <div id="starStudentsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close-modal" onclick="closeStarStudentsModal()">&times;</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span>โญ</span>
                <!-- โจ MODIFIED: Dynamic title -->
                <span id="starStudentsModalTitle">ุงูุทูุงุจ ุงูุญุงุตููู ุนูู ุดุงุฑุฉ ุงูุชููุฒ</span>
            </h2>
            
            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-300 rounded-lg p-4 mb-4">
                <p class="text-sm text-yellow-800">
                    <!-- โจ MODIFIED: Dynamic text -->
                    <span id="starModalDescription">ุงูุทูุงุจ</span> ุงูุฐูู ุญุตููุง ุนูู <strong>20 ุฏุฑุฌุฉ ุฃู ุฃูุซุฑ</strong> ูู ุงูุณููู ุงููููุฒ
                </p>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-yellow-100">
                        <tr>
                            <th class="py-3 px-3 text-center">ุงูุชุฑุชูุจ</th>
                            <!-- โจ MODIFIED: Dynamic header -->
                            <th class="py-3 px-3 text-right" id="starTableStudentHeader">ุงูุทุงูุจ</th>
                            <th class="py-3 px-3 text-right">ุงููุตู</th>
                            <th class="py-3 px-3 text-center">ุนุฏุฏ ุงูุณููููุงุช</th>
                            <th class="py-3 px-3 text-center">ุฅุฌูุงูู ุงูููุงุท</th>
                            <th class="py-3 px-3 text-center">ุงูุดุงุฑุฉ</th>
                        </tr>
                    </thead>
                    <tbody id="starStudentsTableBody">
                        <tr>
                            <td colspan="6" class="py-4 text-center text-gray-500">ูุง ููุฌุฏ ุทูุงุจ ุญุงุตููู ุนูู 20 ุฏุฑุฌุฉ ุฃู ุฃูุซุฑ</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4 flex gap-3">
                <button onclick="printStarStudentsReport()" 
                        class="flex-1 bg-yellow-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-yellow-600 transition-all">
                    ๐จ๏ธ ุทุจุงุนุฉ ุงูุชูุฑูุฑ
                </button>
                <button onclick="closeStarStudentsModal()" 
                        class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition-all">
                    ุฅุบูุงู
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>

        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        //                    CONSTANTS & CONFIGURATION
        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        
        const STORAGE_KEYS = {
            STUDENTS: 'distinguished_students_data',
            STUDENTS_DETAILS: 'distinguished_students_details',
            BEHAVIORS: 'distinguished_behaviors',
            SETTINGS: 'distinguished_settings',
            SCHOOL_NAME: 'school_name',
            SCHOOL_TYPE: 'school_type'  // โจ NEW: ูุญูุธ ููุน ุงููุฏุฑุณุฉ (boys/girls)
        };

     // ๐ ุฅุนุฏุงุฏุงุช ุงูุงูููุฌุฑุงููู (ูุชู ุงูุชุนุฏูู ูู ููุง ููุท)
        const INFOGRAPHIC_CONFIG = {
            link: 'https://salla.sa/digital.goldenveins/dblmbjP',  // โ๏ธ ุนุฏูู ุงูุฑุงุจุท ููุง
            buttonText: 'ุงุญุตู ุนูู ุงูุงูููุฌุฑุงููู ุงูุขู',  // โ๏ธ ุนุฏูู ูุต ุงูุฒุฑ ููุง
            enabled:   true // โ๏ธ false  ูุฅุฎูุงุก ุงูุฒุฑ ุชูุงูุงู
        };

        // โจ NEW: ูุงููุณ ุงููุตูุต ุญุณุจ ููุน ุงููุฏุฑุณุฉ (ุจููู/ุจูุงุช)
        const GENDER_TEXTS = {
            boys: {
                student: 'ุงูุทุงูุจ',
                students: 'ุงูุทูุงุจ',
                studentName: 'ุงุณู ุงูุทุงูุจ',
                selectStudent: 'ุงุฎุชุฑ ุงูุทุงูุจ',
                distinguishedStudents: 'ุงูุทูุงุจ ุงููุชููุฒูู',
                distinguishedStudentsCount: 'ุนุฏุฏ ุงูุทูุงุจ ุงููุชููุฒูู',
                topStudents: 'ุงูุทูุงุจ ุงูุฃูุซุฑ ุชููุฒุงู',
                forStudent: 'ููุทุงูุจ',
                prayerFor: 'ุฏุนูุงุชูุง ูู',
                his: 'ุงูุถุจุงุทู',
                hisAbsence: 'ุบูุงุจู',
                counselor: 'ุงูููุฌู ุงูุทูุงุจู',
                advisor: 'ุงููุฑุดุฏ ุงูุทูุงุจู',
                starStudents: 'ุงูุทูุงุจ ุงูุญุงุตููู ุนูู ุดุงุฑุฉ ุงูุชููุฒ',
                studentSignature: 'ุชูููุน ุงูุทุงูุจ',
                parentSignature: 'ุชูููุน ููู ุงูุฃูุฑ',
                starText: 'ูุชููุฒ',
                sidebarStudents: 'ุทูุงุจ ูุชููุฒูู',
                principal: 'ูุฏูุฑ ุงููุฏุฑุณุฉ'
            },
            girls: {
                student: 'ุงูุทุงูุจุฉ',
                students: 'ุงูุทุงูุจุงุช',
                studentName: 'ุงุณู ุงูุทุงูุจุฉ',
                selectStudent: 'ุงุฎุชุฑ ุงูุทุงูุจุฉ',
                distinguishedStudents: 'ุงูุทุงูุจุงุช ุงููุชููุฒุงุช',
                distinguishedStudentsCount: 'ุนุฏุฏ ุงูุทุงูุจุงุช ุงููุชููุฒุงุช',
                topStudents: 'ุงูุทุงูุจุงุช ุงูุฃูุซุฑ ุชููุฒุงู',
                forStudent: 'ููุทุงูุจุฉ',
                prayerFor: 'ุฏุนูุงุชูุง ููุง',
                his: 'ุงูุถุจุงุทูุง',
                hisAbsence: 'ุบูุงุจูุง',
                counselor: 'ุงูููุฌูุฉ ุงูุทูุงุจูุฉ',
                advisor: 'ุงููุฑุดุฏุฉ ุงูุทูุงุจูุฉ',
                starStudents: 'ุงูุทุงูุจุงุช ุงูุญุงุตูุงุช ุนูู ุดุงุฑุฉ ุงูุชููุฒ',
                studentSignature: 'ุชูููุน ุงูุทุงูุจุฉ',
                parentSignature: 'ุชูููุน ูููุฉ ุงูุฃูุฑ',
                starText: 'ูุชููุฒุฉ',
                sidebarStudents: 'ุทุงูุจุงุช ูุชููุฒุงุช',
                principal: 'ูุฏูุฑุฉ ุงููุฏุฑุณุฉ'
            }
        };

        // Distinguished Behaviors Dictionary (Official) - โ๏ธ ูู ูุชู ุชุนุฏูู ุฃู ุจูุงูุงุช
        const behaviorsByDegree = {
            6: [
                { id: '6-1', name: 'ุงูุถุจุงุท ุงูุทุงูุจ ูุนุฏู ุบูุงุจู ุจุฏูู ุนุฐุฑ ุฎูุงู ุงููุตู ุงูุฏุฑุงุณู', points: 6 },
                { id: '6-2', name: 'ุงููุดุงุฑูุฉ ูู ุงูุฎุฏูุฉ ุงููุฌุชูุนูุฉ ุฎุงุฑุฌ ุงููุฏุฑุณุฉ', points: 6 },
                { id: '6-3', name: 'ุชูุฏูู ูุนุงููุฉ ุญูุงุฑูุฉ', points: 6 },
                { id: '6-4', name: 'ุงููุดุงุฑูุฉ ูู ุญููุฉ ุชูุนูุฉ', points: 6 },
                { id: '6-5', name: 'ุนุฑุถ ุชุฌุงุฑุจ ุดุฎุตูุฉ ูุงุฌุญุฉ', points: 6 },
                { id: '6-6', name: 'ุงูุงูุชุญุงู ุจุจุฑูุงูุฌ ุฃู ุฏูุฑุฉ', points: 6 }
            ],
            4: [
                { id: '4-1', name: 'ุงููุดุงุฑูุฉ ูู ุฃูุดุทุฉ ููุงุฑุงุช ุงูุงุชุตุงู (ุงูุนูู ุงูุฌูุงุนูุ ุงูุชุนูู ุจุงูุฅูุฑุงูุ...)', points: 4 },
                { id: '4-2', name: 'ููุงุฑุงุช ุงูููุงุฏุฉ ูุงููุณุคูููุฉ (ุงูุชุฎุทูุทุ ุงูุชุญููุฒุ ....)', points: 4 },
                { id: '4-3', name: 'ุงููุดุงุฑูุฉ ูู ุฃูุดุทุฉ ุงูููุงุฑุงุช ุงูุฑูููุฉ (ุฅุนุฏุงุฏ ุงูุนุฑูุถุ ุชุตููู ุงููุญุชูู ุงูุฅููุชุฑููู)', points: 4 },
                { id: '4-4', name: 'ุงููุดุงุฑูุฉ ูู ุฃูุดุทุฉ ููุงุฑุฉ ุฅุฏุงุฑุฉ ุงูููุช', points: 4 }
            ],
            2: [
                { id: '2-1', name: 'ูุชุงุจุฉ ุฑุณุงูุฉ ุดูุฑ (ูุซู ุฑุณุงูุฉ ูููุทูุ ููููุงุฏุฉ ุงูุฑุดูุฏุฉุ ููุฃุณุฑุฉุ ูููุนูู ... ุงูุฎ)', points: 2 },
                { id: '2-2', name: 'ุงููุดุงุฑูุฉ ูู ุงูุฅุฐุงุนุฉ', points: 2 },
                { id: '2-3', name: 'ุชูุฏูู ููุชุฑุญ ูุตุงูุญ ุงููุฌุชูุน ุงููุฏุฑุณู', points: 2 },
                { id: '2-4', name: 'ุงูุชุนุงูู ูุน ุงูุฒููุงุก ูุงููุนูููู ูุฅุฏุงุฑุฉ ุงููุฏุฑุณุฉ', points: 2 }
            ],
            other: [
                { id: 'other-1', name: 'ุฃุฎุฑู (ุจูุงุกู ุนูู ุชูุตูุฉ ูุฌูุฉ ุงูุชูุฌูู ุงูุทูุงุจู)', points: 0 }
            ]
        };

        // ๐ ุฎุฑูุทุฉ ุชุญููู ุฑููุฒ ุงูุตููู - ุฌููุน ุงููุฑุงุญู ุงูุชุนููููุฉ
        const gradeCodeMap = {
            '01': 'ุฃูู ุงุจุชุฏุงุฆู',
            '02': 'ุซุงูู ุงุจุชุฏุงุฆู',
            '03': 'ุซุงูุซ ุงุจุชุฏุงุฆู',
            '04': 'ุฑุงุจุน ุงุจุชุฏุงุฆู',
            '05': 'ุฎุงูุณ ุงุจุชุฏุงุฆู',
            '06': 'ุณุงุฏุณ ุงุจุชุฏุงุฆู',
            '07': 'ุฃูู ูุชูุณุท',
            '08': 'ุซุงูู ูุชูุณุท',
            '09': 'ุซุงูุซ ูุชูุณุท',
            '10': 'ุฃูู ุซุงููู',
            '11': 'ุซุงูู ุซุงููู',
            '12': 'ุซุงูุซ ุซุงููู'
        };

        // ๐ ุฏุงูุฉ ุฐููุฉ ูุชุญููู ุฑูุฒ ุงูุตู ุฅูู ุงุณู ุงูุตู
        function decodeGradeCode(code) {
            if (!code) return '';
            code = String(code).trim();
            const numericCode = code.replace(/\D/g, '');
            
            if (gradeCodeMap[code]) return gradeCodeMap[code];
            if (gradeCodeMap[numericCode]) return gradeCodeMap[numericCode];
            
            if (numericCode.length >= 2) {
                const firstTwo = numericCode.substring(0, 2);
                if (gradeCodeMap[firstTwo]) return gradeCodeMap[firstTwo];
            }
            
            if (numericCode.length >= 1) {
                const firstDigit = '0' + numericCode.substring(0, 1);
                if (gradeCodeMap[firstDigit]) return gradeCodeMap[firstDigit];
            }
            
            return code;
        }

        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        //                      STATE MANAGEMENT
        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        
        let studentsByClass = {};
        let selectedDegree = null;
        let selectedBehavior = null;
        let isMultiSelectMode = false;  // โจ NEW: ุญุงูุฉ ุงูุงุฎุชูุงุฑ ุงููุชุนุฏุฏ
        let activeDateFilter = null;     // โจ NEW: ููุชุฑ ุงูุชุงุฑูุฎ ุงููุดุท

        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        //              โจ NEW: GENDER/SCHOOL TYPE FUNCTIONS
        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        
        // โจ NEW: ุงูุญุตูู ุนูู ููุน ุงููุฏุฑุณุฉ ุงูุญุงูู
        function getSchoolType() {
            return localStorage.getItem(STORAGE_KEYS.SCHOOL_TYPE) || 'boys';
        }

        // โจ NEW: ุงูุญุตูู ุนูู ุงููุตูุต ุญุณุจ ููุน ุงููุฏุฑุณุฉ
        function getGenderText(key) {
            const schoolType = getSchoolType();
            return GENDER_TEXTS[schoolType][key] || GENDER_TEXTS['boys'][key];
        }

        // โจ NEW: ุชุญุฏูุซ ุฌููุน ุงููุตูุต ูู ุงูุตูุญุฉ ุญุณุจ ููุน ุงููุฏุฑุณุฉ
        function updateAllGenderTexts() {
            const schoolType = getSchoolType();
            const texts = GENDER_TEXTS[schoolType];
            
            // ุชุญุฏูุซ Labels
            const studentSelectLabel = document.getElementById('studentSelectLabel');
            if (studentSelectLabel) studentSelectLabel.textContent = texts.studentName + ':';
            
            // ุชุญุฏูุซ placeholder ูู select
            const studentSelect = document.getElementById('studentSelect');
            if (studentSelect && studentSelect.options[0]) {
                studentSelect.options[0].textContent = '-- ' + texts.selectStudent + ' --';
            }
            
            // ุชุญุฏูุซ ุนูุงููู ุงูุฅุญุตุงุฆูุงุช
            const totalStudentsLabel = document.getElementById('totalStudentsLabel');
            if (totalStudentsLabel) totalStudentsLabel.textContent = texts.distinguishedStudentsCount;
            
            const topStudentsTitle = document.getElementById('topStudentsTitle');
            if (topStudentsTitle) topStudentsTitle.textContent = texts.topStudents;
            
            const studentColumnHeader = document.getElementById('studentColumnHeader');
            if (studentColumnHeader) studentColumnHeader.textContent = texts.student;
            
            // ุชุญุฏูุซ ุงูุดุฑูุท ุงูุฌุงูุจู
            const sidebarStudentsLabel = document.getElementById('sidebarStudentsLabel');
            if (sidebarStudentsLabel) sidebarStudentsLabel.textContent = texts.sidebarStudents + ':';
            
            // ุชุญุฏูุซ ุตูุฏูู ุงููุฌูุฉ
            const starStudentsLabel = document.getElementById('starStudentsLabel');
            if (starStudentsLabel) starStudentsLabel.textContent = texts.students;
            
            const starStudentsText = document.getElementById('starStudentsText');
            if (starStudentsText) starStudentsText.textContent = texts.starText;
            
            // ุชุญุฏูุซ ุฃุฒุฑุงุฑ ุงูุชูุงุฑูุฑ
            const btnStudentReport = document.getElementById('btnStudentReport');
            if (btnStudentReport) btnStudentReport.textContent = 'ุชูุฑูุฑ ' + texts.student + ' ูุญุฏุฏ';
            
            // ุชุญุฏูุซ ุนูุงููู ุงูุฌุฏุงูู
            const operationsStudentHeader = document.getElementById('operationsStudentHeader');
            if (operationsStudentHeader) operationsStudentHeader.textContent = texts.student;
            
            // ุชุญุฏูุซ ูุงูุฐุฉ ุชูุฑูุฑ ุงูุทุงูุจ
            const filterStudentModalTitle = document.getElementById('filterStudentModalTitle');
            if (filterStudentModalTitle) filterStudentModalTitle.textContent = 'ุชูุฑูุฑ ' + texts.student + ' ูุญุฏุฏ';
            
            const filterStudentSelectLabel = document.getElementById('filterStudentSelectLabel');
            if (filterStudentSelectLabel) filterStudentSelectLabel.textContent = 'ุงุฎุชุฑ ' + texts.student + ':';
            
            // ุชุญุฏูุซ ูุงูุฐุฉ ุงููุชููุฒูู
            const starStudentsModalTitle = document.getElementById('starStudentsModalTitle');
            if (starStudentsModalTitle) starStudentsModalTitle.textContent = texts.starStudents;
            
            const starModalDescription = document.getElementById('starModalDescription');
            if (starModalDescription) starModalDescription.textContent = texts.students;
            
            const starTableStudentHeader = document.getElementById('starTableStudentHeader');
            if (starTableStudentHeader) starTableStudentHeader.textContent = texts.student;
            
            // ุชุญุฏูุซ ุฎูุงุฑุงุช ุงูุฑุงุตุฏ
            const optionCounselor = document.getElementById('optionCounselor');
            if (optionCounselor) {
                optionCounselor.textContent = texts.counselor;
                optionCounselor.value = texts.counselor;
            }
            
            const optionAdvisor = document.getElementById('optionAdvisor');
            if (optionAdvisor) {
                optionAdvisor.textContent = texts.advisor;
                optionAdvisor.value = texts.advisor;
            }
            
            // ุชุญุฏูุซ ุฏููู ุงูุณููู ุงูุฌุงูุจู (ุงูุณููู ุงูุฃูู)
            const guide6_1 = document.getElementById('guide6-1');
            if (guide6_1) {
                guide6_1.textContent = 'โข ' + texts.his + ' ูุนุฏู ' + texts.hisAbsence + ' ุจุฏูู ุนุฐุฑ';
            }
        }

        // โจ NEW: ุนูุฏ ุชุบููุฑ ููุน ุงููุฏุฑุณุฉ
        function onSchoolTypeChange() {
            const schoolType = document.getElementById('schoolTypeSelect').value;
            localStorage.setItem(STORAGE_KEYS.SCHOOL_TYPE, schoolType);
            updateAllGenderTexts();
            
            // ุชุญุฏูุซ ูุงุฆูุฉ ุงูุทูุงุจ ุฅุฐุง ูุงูุช ูุนุฑูุถุฉ ูู ูุถุน ุงูุงุฎุชูุงุฑ ุงููุชุนุฏุฏ
            if (isMultiSelectMode) {
                const selectedClass = document.getElementById('classSelect').value;
                if (selectedClass) {
                    populateMultiSelectStudents(selectedClass);
                }
            }
        }

        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        //              โจ NEW: MULTI-SELECT FUNCTIONS
        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        
        // โจ NEW: ุชุจุฏูู ูุถุน ุงูุงุฎุชูุงุฑ ุงููุชุนุฏุฏ
        function toggleMultiSelectMode() {
            isMultiSelectMode = !isMultiSelectMode;
            
            const singleContainer = document.getElementById('singleSelectContainer');
            const multiContainer = document.getElementById('multiSelectContainer');
            const toggleBtn = document.getElementById('multiSelectToggle');
            const toggleIcon = document.getElementById('multiSelectIcon');
            const toggleText = document.getElementById('multiSelectText');
            
            if (isMultiSelectMode) {
                singleContainer.classList.add('hidden');
                multiContainer.classList.remove('hidden');
                toggleBtn.classList.remove('bg-purple-100', 'text-purple-700');
                toggleBtn.classList.add('bg-purple-600', 'text-white');
                toggleIcon.textContent = 'โ';
                toggleText.textContent = 'ุงุฎุชูุงุฑ ูุฑุฏู';
                
                // ุชุญุฏูุซ ูุงุฆูุฉ ุงูุทูุงุจ ููุงุฎุชูุงุฑ ุงููุชุนุฏุฏ
                const selectedClass = document.getElementById('classSelect').value;
                if (selectedClass) {
                    populateMultiSelectStudents(selectedClass);
                }
            } else {
                singleContainer.classList.remove('hidden');
                multiContainer.classList.add('hidden');
                toggleBtn.classList.add('bg-purple-100', 'text-purple-700');
                toggleBtn.classList.remove('bg-purple-600', 'text-white');
                toggleIcon.textContent = 'โ';
                toggleText.textContent = 'ุชุญุฏูุฏ ูุชุนุฏุฏ';
            }
        }

        // โจ NEW: ููุก ูุงุฆูุฉ ุงูุทูุงุจ ููุงุฎุชูุงุฑ ุงููุชุนุฏุฏ
        function populateMultiSelectStudents(className) {
            const container = document.getElementById('studentsCheckboxList');
            const texts = GENDER_TEXTS[getSchoolType()];
            
            if (!className || !studentsByClass[className]) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">ุงุฎุชุฑ ุงูุตู ุฃููุงู</p>';
                updateSelectedCount();
                return;
            }
            
            const students = studentsByClass[className];
            container.innerHTML = '';
            
            students.forEach((student, index) => {
                const item = document.createElement('label');
                item.className = 'student-checkbox-item';
                item.innerHTML = `
                    <input type="checkbox" value="${student}" onchange="onStudentCheckboxChange(this)">
                    <span>${student}</span>
                `;
                container.appendChild(item);
            });
            
            updateSelectedCount();
        }

        // โจ NEW: ุนูุฏ ุชุบููุฑ ุญุงูุฉ checkbox
        function onStudentCheckboxChange(checkbox) {
            const item = checkbox.closest('.student-checkbox-item');
            if (checkbox.checked) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
            updateSelectedCount();
        }

        // โจ NEW: ุชุญุฏูุซ ุนุฏุงุฏ ุงููุญุฏุฏูู
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('#studentsCheckboxList input[type="checkbox"]:checked');
            const badge = document.getElementById('selectedCountBadge');
            const count = checkboxes.length;
            badge.textContent = count + ' ูุญุฏุฏ';
            
            if (count > 0) {
                badge.classList.remove('bg-gray-400');
                badge.classList.add('bg-blue-600');
            } else {
                badge.classList.add('bg-gray-400');
                badge.classList.remove('bg-blue-600');
            }
        }

        // โจ NEW: ุชุญุฏูุฏ ุงููู
        function selectAllStudents() {
            const checkboxes = document.querySelectorAll('#studentsCheckboxList input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = true;
                cb.closest('.student-checkbox-item').classList.add('selected');
            });
            updateSelectedCount();
        }

        // โจ NEW: ุฅูุบุงุก ุชุญุฏูุฏ ุงููู
        function deselectAllStudents() {
            const checkboxes = document.querySelectorAll('#studentsCheckboxList input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
                cb.closest('.student-checkbox-item').classList.remove('selected');
            });
            updateSelectedCount();
        }

        // โจ NEW: ุงูุญุตูู ุนูู ุงูุทูุงุจ ุงููุญุฏุฏูู
        function getSelectedStudents() {
            if (!isMultiSelectMode) {
                const student = document.getElementById('studentSelect').value;
                return student ? [student] : [];
            }
            
            const checkboxes = document.querySelectorAll('#studentsCheckboxList input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        //              DATE FILTER FUNCTIONS - FIXED
        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        
        // ๐ ุชุญููู ุงูุชุงุฑูุฎ ุงููุฌุฑู ุฅูู ูุงุฆู ูุงุจู ููููุงุฑูุฉ
        function parseHijriDate(dateStr) {
            if (!dateStr) return null;
            
            // ุงูุชุงุฑูุฎ ูุฏ ูููู ุจุนุฏุฉ ุตูุบ
            // ุตูุบุฉ 1: "15/6/1446 ูู" ุฃู "15/06/1446"
            // ุตูุบุฉ 2: "1446/6/15"
            // ุตูุบุฉ 3: "ูกูฅ/ูฆ/ูกูคูคูฆ"
            
            // ุชุญููู ุงูุฃุฑูุงู ุงูุนุฑุจูุฉ ุฅูู ุฅูุฌููุฒูุฉ
            const arabicNums = 'ููกูขูฃูคูฅูฆูงูจูฉ';
            let cleanDate = dateStr;
            for (let i = 0; i < 10; i++) {
                cleanDate = cleanDate.replace(new RegExp(arabicNums[i], 'g'), i.toString());
            }
            
            // ุฅุฒุงูุฉ "ูู" ูุงููุณุงูุงุช ุงูุฒุงุฆุฏุฉ
            cleanDate = cleanDate.replace(/ูู/g, '').replace(/\s+/g, '').trim();
            
            const parts = cleanDate.split('/');
            if (parts.length !== 3) return null;
            
            let year, month, day;
            
            // ุชุญุฏูุฏ ุงูุตูุบุฉ ุจูุงุกู ุนูู ุทูู ุงูุฃุฑูุงู
            const p0 = parseInt(parts[0]);
            const p1 = parseInt(parts[1]);
            const p2 = parseInt(parts[2]);
            
            if (parts[0].length === 4 || p0 > 1400) {
                // ุตูุบุฉ YYYY/MM/DD
                year = p0;
                month = p1;
                day = p2;
            } else if (parts[2].length === 4 || p2 > 1400) {
                // ุตูุบุฉ DD/MM/YYYY
                day = p0;
                month = p1;
                year = p2;
            } else {
                // ุงูุชุฑุงุถ DD/MM/YYYY
                day = p0;
                month = p1;
                year = p2;
            }
            
            return { year, month, day, raw: dateStr };
        }

        // ๐ ููุงุฑูุฉ ุชุงุฑูุฎูู ูุฌุฑููู
        function compareHijriDates(date1, date2) {
            if (!date1 || !date2) return 0;
            
            if (date1.year !== date2.year) return date1.year - date2.year;
            if (date1.month !== date2.month) return date1.month - date2.month;
            return date1.day - date2.day;
        }

        // ๐ ุชุญููู ุชุงุฑูุฎ ูููุงุฏู ูู ุญูู input ุฅูู ูุฌุฑู ุชูุฑูุจู
        function inputDateToHijri(inputDate) {
            if (!inputDate) return null;
            
            // inputDate ุจุตูุบุฉ YYYY-MM-DD
            const date = new Date(inputDate);
            
            try {
                // ุงุณุชุฎุฏุงู API ุงููุชุตูุญ ููุชุญููู
                const hijriStr = date.toLocaleDateString('ar-SA-u-ca-islamic', {
                    year: 'numeric',
                    month: 'numeric',
                    day: 'numeric'
                });
                
                return parseHijriDate(hijriStr);
            } catch (e) {
                // ุญุณุงุจ ุชูุฑูุจู ุฅุฐุง ูุดู API
                const gregorianYear = date.getFullYear();
                const gregorianMonth = date.getMonth() + 1;
                const gregorianDay = date.getDate();
                
                // ุชุญููู ุชูุฑูุจู (ุงููุฑู ุญูุงูู 579 ุณูุฉ)
                const hijriYear = Math.round(gregorianYear - 579 - (gregorianYear - 2000) * 0.03);
                
                return {
                    year: hijriYear,
                    month: gregorianMonth,
                    day: gregorianDay
                };
            }
        }

        // ๐ ููุชุฑุฉ ุงูุณููููุงุช ุจุงูุชุงุฑูุฎ
        function filterBehaviorsByDate(behaviors, fromDate, toDate) {
            if (!fromDate && !toDate) return behaviors;
            
            return behaviors.filter(b => {
                const behaviorDate = parseHijriDate(b.date);
                if (!behaviorDate) return true; // ุฅุฐุง ูู ูููู ุชุญููู ุงูุชุงุฑูุฎุ ุฃุจูู ุงูุณุฌู
                
                let passFrom = true;
                let passTo = true;
                
                if (fromDate) {
                    passFrom = compareHijriDates(behaviorDate, fromDate) >= 0;
                }
                
                if (toDate) {
                    passTo = compareHijriDates(behaviorDate, toDate) <= 0;
                }
                
                return passFrom && passTo;
            });
        }

        // ๐ ุชุทุจูู ููุชุฑ ุงูุชุงุฑูุฎ ุนูู ุงูุนุฑุถ ุงูุฑุฆูุณู
        function applyDateFilter() {
            const fromDateInput = document.getElementById('filterDateFrom').value;
            const toDateInput = document.getElementById('filterDateTo').value;
            
            if (!fromDateInput && !toDateInput) {
                alert('โ๏ธ ูุฑุฌู ุชุญุฏูุฏ ุชุงุฑูุฎ ุงูุจุฏุงูุฉ ุฃู ุงูููุงูุฉ ุนูู ุงูุฃูู');
                return;
            }
            
            const fromDate = inputDateToHijri(fromDateInput);
            const toDate = inputDateToHijri(toDateInput);
            
            activeDateFilter = {
                from: fromDate,
                to: toDate,
                fromStr: fromDateInput,
                toStr: toDateInput
            };
            
            // ุนุฑุถ ุงูุณููููุงุช ุงููููุชุฑุฉ
            displayOperations();
        }

        // ๐ ุฅูุบุงุก ููุชุฑ ุงูุชุงุฑูุฎ
        function clearDateFilter() {
            activeDateFilter = null;
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            
            const badge = document.getElementById('activeDateFilterBadge');
            if (badge) badge.classList.add('hidden');
            
            // ุฅุนุงุฏุฉ ุนุฑุถ ุฌููุน ุงูุณููููุงุช
            displayOperations();
        }

        // ๐ ุนุฑุถ ุงูุณููููุงุช ูุน ุฏุนู ุงูููุชุฑุฉ
        function displayOperations() {
            let behaviors = JSON.parse(localStorage.getItem(STORAGE_KEYS.BEHAVIORS) || '[]');
            
            // ุชุทุจูู ููุชุฑ ุงูุชุงุฑูุฎ ุฅุฐุง ูุงู ูุดุทุงู
            if (activeDateFilter) {
                behaviors = filterBehaviorsByDate(behaviors, activeDateFilter.from, activeDateFilter.to);
                
                // ุนุฑุถ ูุคุดุฑ ุงูููุชุฑ ุงููุดุท
                const badge = document.getElementById('activeDateFilterBadge');
                const text = document.getElementById('activeDateFilterText');
                
                if (badge && text) {
                    badge.classList.remove('hidden');
                    
                    let filterText = '๐ ุงูููุชุฑ: ';
                    if (activeDateFilter.fromStr && activeDateFilter.toStr) {
                        filterText += `ูู ${activeDateFilter.fromStr} ุฅูู ${activeDateFilter.toStr}`;
                    } else if (activeDateFilter.fromStr) {
                        filterText += `ูู ${activeDateFilter.fromStr}`;
                    } else {
                        filterText += `ุญุชู ${activeDateFilter.toStr}`;
                    }
                    text.textContent = filterText;
                }
            } else {
                const badge = document.getElementById('activeDateFilterBadge');
                if (badge) badge.classList.add('hidden');
            }
            
            displayFilteredOperations(behaviors, 'ุงูุณููููุงุช ุงููุณุฌูุฉ');
        }

        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        //              โจ NEW: STAR BADGE FUNCTIONS (20+ Points)
        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        
        // โจ NEW: ุญุณุงุจ ูุฌููุน ููุงุท ุงูุทุงูุจ
        function getStudentTotalPoints(studentName, behaviors) {
            if (!behaviors) {
                behaviors = JSON.parse(localStorage.getItem(STORAGE_KEYS.BEHAVIORS) || '[]');
            }
            
            return behaviors
                .filter(b => b.student === studentName)
                .reduce((sum, b) => {
                    const behaviorType = typeof b.behaviorType === 'string' 
                        ? JSON.parse(b.behaviorType) 
                        : b.behaviorType;
                    return sum + (behaviorType.points || 0);
                }, 0);
        }

        // โจ NEW: ุงูุชุญูู ูู ุงุณุชุญูุงู ุดุงุฑุฉ ุงููุฌูุฉ
        function hasStarBadge(studentName, behaviors) {
            return getStudentTotalPoints(studentName, behaviors) >= 20;
        }

        // โจ NEW: ุงูุญุตูู ุนูู HTML ุดุงุฑุฉ ุงููุฌูุฉ
        function getStarBadgeHTML(points) {
            if (points >= 20) {
                return '<span class="star-badge">โญ ' + getGenderText('starText') + '</span>';
            }
            return '';
        }

        // โจ NEW: ุงูุญุตูู ุนูู ูุงุฆูุฉ ุงูุทูุงุจ ุงูุญุงุตููู ุนูู 20+ ุฏุฑุฌุฉ
        function getStarStudents() {
            const behaviors = JSON.parse(localStorage.getItem(STORAGE_KEYS.BEHAVIORS) || '[]');
            const studentStats = {};
            
            behaviors.forEach(b => {
                if (!studentStats[b.student]) {
                    studentStats[b.student] = {
                        class: b.class,
                        count: 0,
                        points: 0
                    };
                }
                studentStats[b.student].count++;
                
                const behaviorType = typeof b.behaviorType === 'string' 
                    ? JSON.parse(b.behaviorType) 
                    : b.behaviorType;
                studentStats[b.student].points += (behaviorType.points || 0);
            });
            
            // ููุชุฑุฉ ุงูุทูุงุจ ุงูุญุงุตููู ุนูู 20+ ูุชุฑุชูุจูู
            return Object.entries(studentStats)
                .filter(([name, data]) => data.points >= 20)
                .sort((a, b) => b[1].points - a[1].points)
                .map(([name, data], index) => ({
                    rank: index + 1,
                    name,
                    class: data.class,
                    count: data.count,
                    points: data.points
                }));
        }

        // โจ NEW: ุนุฑุถ ูุงูุฐุฉ ุชูุฑูุฑ ุงููุชููุฒูู
        function showStarStudentsReport() {
            const starStudents = getStarStudents();
            const tbody = document.getElementById('starStudentsTableBody');
            const texts = GENDER_TEXTS[getSchoolType()];
            
            if (starStudents.length === 0) {
                tbody.innerHTML = `<tr>
                    <td colspan="6" class="py-4 text-center text-gray-500">
                        ูุง ููุฌุฏ ${texts.students} ุญุงุตููู ุนูู 20 ุฏุฑุฌุฉ ุฃู ุฃูุซุฑ
                    </td>
                </tr>`;
            } else {
                tbody.innerHTML = '';
                starStudents.forEach(student => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-yellow-50';
                    row.innerHTML = `
                        <td class="py-3 px-3 text-center font-bold text-yellow-600">${student.rank}</td>
                        <td class="py-3 px-3 font-semibold">${student.name}</td>
                        <td class="py-3 px-3">${student.class}</td>
                        <td class="py-3 px-3 text-center">${student.count}</td>
                        <td class="py-3 px-3 text-center font-bold text-green-600">+${student.points}</td>
                        <td class="py-3 px-3 text-center">
                            <span class="star-badge">โญ ${texts.starText}</span>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            document.getElementById('starStudentsModal').style.display = 'block';
        }

        // โจ NEW: ุฅุบูุงู ูุงูุฐุฉ ุงููุชููุฒูู
        function closeStarStudentsModal() {
            document.getElementById('starStudentsModal').style.display = 'none';
        }

        // โจ NEW: ุทุจุงุนุฉ ุชูุฑูุฑ ุงููุชููุฒูู
        function printStarStudentsReport() {
            const starStudents = getStarStudents();
            const texts = GENDER_TEXTS[getSchoolType()];
            const schoolName = document.getElementById('schoolNameInput').value || 'ุงููุฏุฑุณุฉ';
            
            if (starStudents.length === 0) {
                alert('ูุง ููุฌุฏ ' + texts.students + ' ุญุงุตููู ุนูู 20 ุฏุฑุฌุฉ ุฃู ุฃูุซุฑ');
                return;
            }
            
            let tableRows = '';
            starStudents.forEach(student => {
                tableRows += `
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 12px; text-align: center; font-weight: bold; color: #d97706;">${student.rank}</td>
                        <td style="padding: 12px; font-weight: bold;">${student.name}</td>
                        <td style="padding: 12px;">${student.class}</td>
                        <td style="padding: 12px; text-align: center;">${student.count}</td>
                        <td style="padding: 12px; text-align: center; font-weight: bold; color: #059669;">+${student.points}</td>
                        <td style="padding: 12px; text-align: center;">โญ</td>
                    </tr>
                `;
            });
            
            const reportHTML = `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Tajawal', sans-serif; padding: 40px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #f59e0b; padding-bottom: 20px; }
                        .header h1 { color: #d97706; font-size: 28px; margin: 10px 0; }
                        .summary { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th { background-color: #f59e0b; color: white; padding: 12px; text-align: right; }
                        td { padding: 12px; }
                        tr:nth-child(even) { background-color: #fffbeb; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>โญ ุชูุฑูุฑ ${texts.starStudents} โญ</h1>
                        <h2 style="color: #059669; font-size: 20px;">${schoolName}</h2>
                        <p style="color: #6b7280;">${texts.students} ุงูุญุงุตููู ุนูู 20 ุฏุฑุฌุฉ ุฃู ุฃูุซุฑ ูู ุงูุณููู ุงููููุฒ</p>
                    </div>
                    
                    <div class="summary">
                        <span style="font-size: 48px;">๐</span>
                        <h3 style="color: #d97706; margin: 10px 0;">ุฅุฌูุงูู ${texts.distinguishedStudents}: ${starStudents.length}</h3>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th style="text-align: center; width: 60px;">ุงูุชุฑุชูุจ</th>
                                <th>${texts.student}</th>
                                <th>ุงููุตู</th>
                                <th style="text-align: center;">ุนุฏุฏ ุงูุณููููุงุช</th>
                                <th style="text-align: center;">ุฅุฌูุงูู ุงูููุงุท</th>
                                <th style="text-align: center;">ุงูุดุงุฑุฉ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 50px; text-align: center; color: #6b7280; font-size: 14px;">
                        <p>ุชู ุฅูุดุงุก ุงูุชูุฑูุฑ ุจุชุงุฑูุฎ: ${new Date().toLocaleDateString('ar-SA')}</p>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(reportHTML);
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 500);
        }

        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        //                      INITIALIZATION
        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        
        window.addEventListener('DOMContentLoaded', function() {
            // Load saved data
            loadSavedData();
            
            // Setup event listeners
            setupEventListeners();
            
            // Update statistics
            updateAllStatistics();
            
            // Load school name and type
            loadSchoolName();
            loadSchoolType();  // โจ NEW
            
            // Update gender texts
            updateAllGenderTexts();  // โจ NEW
            
            // Update infographic link
            updateInfographicLink();
        });

        function loadSavedData() {
            try {
                const savedStudents = localStorage.getItem(STORAGE_KEYS.STUDENTS);
                if (savedStudents) {
                    studentsByClass = JSON.parse(savedStudents);
                    populateClasses();
                }
            } catch (e) {
                console.error("ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช:", e);
            }
        }

        // โจ NEW: ุชุญููู ููุน ุงููุฏุฑุณุฉ
        function loadSchoolType() {
            const savedType = localStorage.getItem(STORAGE_KEYS.SCHOOL_TYPE) || 'boys';
            const selectElement = document.getElementById('schoolTypeSelect');
            if (selectElement) {
                selectElement.value = savedType;
            }
        }

        function setupEventListeners() {
            // Custom sender input
            document.getElementById('senderSelect').addEventListener('change', function() {
                const customInput = document.getElementById('customSenderInput');
                if (this.value === 'custom') {
                    customInput.classList.remove('hidden');
                } else {
                    customInput.classList.add('hidden');
                }
            });
            
            // School name save
            document.getElementById('schoolNameInput').addEventListener('change', function() {
                localStorage.setItem(STORAGE_KEYS.SCHOOL_NAME, this.value);
            });
        }

        function loadSchoolName() {
            const savedName = localStorage.getItem(STORAGE_KEYS.SCHOOL_NAME);
            if (savedName) {
                document.getElementById('schoolNameInput').value = savedName;
            }
            
            // ุชุทุจูู ุฅุนุฏุงุฏุงุช ุงูุงูููุฌุฑุงููู ุนูุฏ ุงูุชุญููู
const infographicSection = document.getElementById('infographicLinkSection');
if (infographicSection && INFOGRAPHIC_CONFIG.enabled) {
    infographicSection.style.display = 'block';
    const linkButton = document.getElementById('infographicLinkButton');
    const buttonTextDisplay = document.getElementById('infographicButtonTextDisplay');
    if (linkButton && buttonTextDisplay) {
        linkButton.href = INFOGRAPHIC_CONFIG.link;
        buttonTextDisplay.textContent = INFOGRAPHIC_CONFIG.buttonText;
    }
}

        }
        
        function updateInfographicLink() {
            // Already handled in loadSchoolName
        }

        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        //                    EXCEL IMPORT - ENHANCED FOR NOOR
        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        
        function importStudentsFromExcel() {
            const fileInput = document.getElementById('excelFile');
            const statusDiv = document.getElementById('importStatus');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showStatus('โ๏ธ ูุฑุฌู ุงุฎุชูุงุฑ ููู Excel', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // ๐ ุงูุจุญุซ ูู ุฌููุน ุงูุตูุญุงุช ููุนุซูุฑ ุนูู ุตูุญุฉ ุงูุจูุงูุงุช
                    let targetSheet = null;
                    let targetSheetName = '';
                    
                    for (let i = 0; i < workbook.SheetNames.length; i++) {
                        const sheetName = workbook.SheetNames[i];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                        
                        // ุงูุจุญุซ ุนู ุตูุญุฉ ุชุญุชูู ุนูู ุจูุงูุงุช ูุนููุฉ (ุฃูุซุฑ ูู 5 ุตููู ูุฃุนูุฏุฉ)
                        if (jsonData.length > 5) {
                            // ุงูุชุญูู ูู ูุฌูุฏ ุนูุงููู ูุนุฑููุฉ
                            const hasStudentData = jsonData.some(row => {
                                const rowText = row.join(' ');
                                return rowText.includes('ุงุณู ุงูุทุงูุจ') || 
                                       rowText.includes('ุงูุทุงูุจ') ||
                                       rowText.includes('ุงููุตู') ||
                                       rowText.includes('ุฑูู ุงูุตู');
                            });
                            
                            if (hasStudentData) {
                                targetSheet = worksheet;
                                targetSheetName = sheetName;
                                break;
                            }
                        }
                    }
                    
                    // ุฅุฐุง ูู ูุชู ุงูุนุซูุฑุ ุฌุฑุจ ุงูุตูุญุฉ ุงูุซุงููุฉ (ููุง ูู ูููุงุช ููุฑ)
                    if (!targetSheet && workbook.SheetNames.length >= 2) {
                        targetSheet = workbook.Sheets[workbook.SheetNames[1]];
                        targetSheetName = workbook.SheetNames[1];
                    }
                    
                    // ุฅุฐุง ูู ูุชู ุงูุนุซูุฑุ ุงุณุชุฎุฏู ุงูุตูุญุฉ ุงูุฃููู
                    if (!targetSheet) {
                        targetSheet = workbook.Sheets[workbook.SheetNames[0]];
                        targetSheetName = workbook.SheetNames[0];
                    }
                    
                    const jsonData = XLSX.utils.sheet_to_json(targetSheet, { header: 1, defval: '' });
                    
                    if (jsonData.length < 2) {
                        showStatus('โ๏ธ ุงูููู ูุงุฑุบ ุฃู ูุง ูุญุชูู ุนูู ุจูุงูุงุช ูุงููุฉ', 'error');
                        return;
                    }
                    
                    // Process students data
                    processNoorExcelData(jsonData, targetSheetName);
                    
                } catch (error) {
                    console.error("ุฎุทุฃ:", error);
                    showStatus('โ ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู: ' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                showStatus('โ ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // ๐ ุฏุงูุฉ ูุญุณููุฉ ููุนุงูุฌุฉ ุจูุงูุงุช ูุธุงู ููุฑ
        function processNoorExcelData(jsonData, sheetName) {
            // ๐ ุงูุจุญุซ ุนู ุตู ุงูุนูุงููู (ูุญุชูู ุนูู "ุงุณู ุงูุทุงูุจ" ุฃู "ุงูุทุงูุจ")
            let headerRowIndex = -1;
            let headers = [];
            
            for (let i = 0; i < Math.min(jsonData.length, 10); i++) {
                const row = jsonData[i];
                if (!row) continue;
                
                const rowText = row.join(' ').toLowerCase();
                if (rowText.includes('ุงุณู ุงูุทุงูุจ') || 
                    (rowText.includes('ุงูุทุงูุจ') && rowText.includes('ุงููุตู'))) {
                    headerRowIndex = i;
                    headers = row;
                    break;
                }
            }
            
            // ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนูุงูููุ ุฌุฑุจ ุงูุณุทุฑ 3 ุฃู 4 (ููุง ูู ููุฑ)
            if (headerRowIndex === -1) {
                for (let tryRow of [3, 2, 4, 1, 0]) {
                    if (jsonData[tryRow] && jsonData[tryRow].some(cell => cell && String(cell).trim())) {
                        headerRowIndex = tryRow;
                        headers = jsonData[tryRow];
                        break;
                    }
                }
            }
            
            if (headerRowIndex === -1) {
                showStatus('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุนูุงููู ุงูุฃุนูุฏุฉ', 'error');
                return;
            }
            
            // ๐ ุชุญุฏูุฏ ููุงุฑุณ ุงูุฃุนูุฏุฉ ูุน ุชุฌุงูู ุงูุฃุนูุฏุฉ ุงููุงุฑุบุฉ
            let studentNameIndex = -1;
            let gradeCodeIndex = -1;  // ุฑูู ุงูุตู (ุงูุชุฑููุฒ)
            let classIndex = -1;      // ุงููุตู (ุงูุดุนุจุฉ)
            let phoneIndex = -1;      // ุงูุฌูุงู
            let studentIdIndex = -1;  // ุฑูู ุงูุทุงูุจ
            
            headers.forEach((header, index) => {
                if (!header) return;
                const h = String(header).trim();
                
                // ุงุณู ุงูุทุงูุจ
                if (h.includes('ุงุณู ุงูุทุงูุจ') || h === 'ุงูุทุงูุจ' || h === 'ุงุณู') {
                    studentNameIndex = index;
                }
                // ุฑูู ุงูุตู (ุงูุชุฑููุฒ) - ููู ููุชุญููู
                if (h.includes('ุฑูู ุงูุตู') || h === 'ุงูุตู' || h.includes('ุงููุฑุญูุฉ')) {
                    gradeCodeIndex = index;
                }
                // ุงููุตู (ุงูุดุนุจุฉ)
                if (h === 'ุงููุตู' || h.includes('ุงูุดุนุจุฉ') || h.includes('ุดุนุจุฉ')) {
                    classIndex = index;
                }
                // ุงูุฌูุงู
                if (h.includes('ุฌูุงู') || h.includes('ูุงุชู') || h.includes('ุงูุฌูุงู') || h.includes('ููู')) {
                    phoneIndex = index;
                }
                // ุฑูู ุงูุทุงูุจ
                if (h.includes('ุฑูู ุงูุทุงูุจ') || h.includes('ุฑูู ุงููููุฉ') || h.includes('ุงููููุฉ')) {
                    studentIdIndex = index;
                }
            });
            
            // ๐ ูุญุงููุฉ ุงููุดู ุงูุชููุงุฆู ูุชูุณูู ููุฑ (B-F)
            // ุชุฑุชูุจ ููุฑ: ุงูุฌูุงู(B) - ุงููุตู(C) - ุฑูู ุงูุตู(D) - ุงุณู ุงูุทุงูุจ(E) - ุฑูู ุงูุทุงูุจ(F)
            if (studentNameIndex === -1) {
                // ุงูุจุญุซ ูู ุงูุจูุงูุงุช ูููุดู ุนู ุงูุฃุนูุฏุฉ
                for (let i = headerRowIndex + 1; i < Math.min(jsonData.length, headerRowIndex + 5); i++) {
                    const row = jsonData[i];
                    if (!row) continue;
                    
                    for (let j = 0; j < row.length; j++) {
                        const cell = String(row[j] || '').trim();
                        
                        // ุงููุดู ุนู ุนููุฏ ุงูุงุณู (ูุญุชูู ุนูู ูุณุงูุงุช ูุฃุญุฑู ุนุฑุจูุฉ)
                        if (cell.length > 5 && cell.includes(' ') && /[\u0600-\u06FF]/.test(cell)) {
                            if (studentNameIndex === -1) studentNameIndex = j;
                        }
                        
                        // ุงููุดู ุนู ุนููุฏ ุฑูู ุงูุตู (ุฑูู ูู 1-12 ุฃู ุชุฑููุฒ)
                        if (/^[0-9]{1,2}$/.test(cell) || /^[0-9]{8,}$/.test(cell.replace(/\D/g, ''))) {
                            if (gradeCodeIndex === -1 && parseInt(cell) <= 12) {
                                gradeCodeIndex = j;
                            }
                        }
                        
                        // ุงููุดู ุนู ุนููุฏ ุงูุฌูุงู (ูุจุฏุฃ ุจู 05)
                        if (/^05[0-9]{8}$/.test(cell.replace(/\D/g, ''))) {
                            if (phoneIndex === -1) phoneIndex = j;
                        }
                    }
                }
            }
            
            // ุชุนููู ุงูุชุฑุงุถู ูุชูุณูู ููุฑ ุฅุฐุง ูู ูุชู ุงููุดู
            if (studentNameIndex === -1) {
                // ุงูุชุฑุงุถ ุชูุณูู ููุฑ: A ูุงุฑุบุ B=ุฌูุงูุ C=ูุตูุ D=ุฑูู ุตูุ E=ุงุณู
                studentNameIndex = 4; // ุงูุนููุฏ E
                gradeCodeIndex = 3;   // ุงูุนููุฏ D
                classIndex = 2;       // ุงูุนููุฏ C
                phoneIndex = 1;       // ุงูุนููุฏ B
            }
            
            if (studentNameIndex === -1) {
                showStatus('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุนููุฏ ุงุณู ุงูุทุงูุจ', 'error');
                return;
            }
            
            // ๐ ูุนุงูุฌุฉ ุงูุจูุงูุงุช
            studentsByClass = {};
            const studentsDetails = [];
            let totalStudents = 0;
            let skippedRows = 0;
            
            for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row) continue;
                
                // ุชุฌุงูู ุงูุตููู ุงููุงุฑุบุฉ
                const rowContent = row.filter(cell => cell && String(cell).trim()).length;
                if (rowContent < 2) {
                    skippedRows++;
                    continue;
                }
                
                const studentName = row[studentNameIndex] ? String(row[studentNameIndex]).trim() : '';
                if (!studentName || studentName.length < 3) {
                    skippedRows++;
                    continue;
                }
                
                // ุงูุญุตูู ุนูู ุฑูู ุงูุตู (ุงูุชุฑููุฒ)
                let gradeCode = gradeCodeIndex !== -1 && row[gradeCodeIndex] 
                    ? String(row[gradeCodeIndex]).trim() 
                    : '';
                
                // ุงูุญุตูู ุนูู ุงููุตู/ุงูุดุนุจุฉ
                let className = classIndex !== -1 && row[classIndex] 
                    ? String(row[classIndex]).trim() 
                    : '';
                
                // ุงูุญุตูู ุนูู ุงูุฌูุงู
                let phone = phoneIndex !== -1 && row[phoneIndex] 
                    ? String(row[phoneIndex]).trim() 
                    : '';
                
                // ุชุญููู ุฑูู ุงูุตู ุฅูู ุงุณู ุงูุตู
                const decodedGrade = decodeGradeCode(gradeCode);
                
                // ุชูููู ุงุณู ุงููุตู ุงููุงูู
                let fullClassName = '';
                if (decodedGrade) {
                    fullClassName = className ? `${decodedGrade} / ${className}` : decodedGrade;
                } else if (gradeCode) {
                    fullClassName = className ? `${gradeCode} / ${className}` : gradeCode;
                } else if (className) {
                    fullClassName = className;
                } else {
                    fullClassName = 'ุบูุฑ ูุญุฏุฏ';
                }
                
                // ุฅุถุงูุฉ ูููุงุฆูุฉ
                if (!studentsByClass[fullClassName]) {
                    studentsByClass[fullClassName] = [];
                }
                
                if (!studentsByClass[fullClassName].includes(studentName)) {
                    studentsByClass[fullClassName].push(studentName);
                    totalStudents++;
                    
                    studentsDetails.push({
                        name: studentName,
                        class: fullClassName,
                        phone: phone,
                        gradeCode: gradeCode,
                        originalGrade: decodedGrade
                    });
                }
            }
            
            if (totalStudents === 0) {
                showStatus('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุจูุงูุงุช ุทูุงุจ ุตุงูุญุฉ ูู ุงูููู', 'error');
                return;
            }
            
            // ุญูุธ ุงูุจูุงูุงุช
            localStorage.setItem(STORAGE_KEYS.STUDENTS, JSON.stringify(studentsByClass));
            localStorage.setItem(STORAGE_KEYS.STUDENTS_DETAILS, JSON.stringify(studentsDetails));
            
            // ุชุญุฏูุซ ุงููุงุฌูุฉ
            populateClasses();
            
            const classCount = Object.keys(studentsByClass).length;
            const studentText = getGenderText('students');
            showStatus(`โ ุชู ุงุณุชูุฑุงุฏ ${totalStudents} ${studentText} ูู ${classCount} ูุตู ุจูุฌุงุญ<br>
                        <small style="color:#6b7280;">๐ ุงูุตูุญุฉ: ${sheetName} | โญ๏ธ ุตููู ูุชุฌุงููุฉ: ${skippedRows}</small>`, 'success');
        }

        function showStatus(message, type) {  
            const statusDiv = document.getElementById('importStatus');  
            statusDiv.classList.remove('hidden');  
            statusDiv.className = `mt-4 p-4 rounded-lg ${type === 'error' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`;  
            statusDiv.innerHTML = message;  
        }  

        // ๐ ุฏุงูุฉ ุชุฑุชูุจ ุงูุตููู ุจุดูู ููุทูู
        function sortClassesLogically(classes) {
            const gradeOrder = {
                'ุฃูู ุงุจุชุฏุงุฆู': 1, 'ุซุงูู ุงุจุชุฏุงุฆู': 2, 'ุซุงูุซ ุงุจุชุฏุงุฆู': 3,
                'ุฑุงุจุน ุงุจุชุฏุงุฆู': 4, 'ุฎุงูุณ ุงุจุชุฏุงุฆู': 5, 'ุณุงุฏุณ ุงุจุชุฏุงุฆู': 6,
                'ุฃูู ูุชูุณุท': 7, 'ุซุงูู ูุชูุณุท': 8, 'ุซุงูุซ ูุชูุณุท': 9,
                'ุฃูู ุซุงููู': 10, 'ุซุงูู ุซุงููู': 11, 'ุซุงูุซ ุซุงููู': 12
            };
            
            return classes.sort((a, b) => {
                // ุงุณุชุฎุฑุงุฌ ุงุณู ุงูุตู ูู ุงุณู ุงููุตู ุงููุงูู
                let gradeA = 999, gradeB = 999;
                let sectionA = '', sectionB = '';
                
                for (const [gradeName, order] of Object.entries(gradeOrder)) {
                    if (a.includes(gradeName)) {
                        gradeA = order;
                        sectionA = a.replace(gradeName, '').replace(/[\/\-\s]+/g, '').trim();
                    }
                    if (b.includes(gradeName)) {
                        gradeB = order;
                        sectionB = b.replace(gradeName, '').replace(/[\/\-\s]+/g, '').trim();
                    }
                }
                
                // ุชุฑุชูุจ ุญุณุจ ุงูุตู ุฃููุงู
                if (gradeA !== gradeB) {
                    return gradeA - gradeB;
                }
                
                // ุซู ุชุฑุชูุจ ุญุณุจ ุงูุดุนุจุฉ (ุฃุ ุจุ ุฌ ุฃู 1ุ 2ุ 3)
                return sectionA.localeCompare(sectionB, 'ar');
            });
        }

        // ๐ ุชุญุฏูุซ ุฏุงูุฉ populateClasses ูุงุณุชุฎุฏุงู ุงูุชุฑุชูุจ ุงูููุทูู
        function populateClasses() {
            const classSelect = document.getElementById('classSelect');
            const filterClassSelect = document.getElementById('filterClassSelect');
            const filterClassOnlySelect = document.getElementById('filterClassOnlySelect');
            
            // โจ ุงุณุชุฎุฏุงู ุงูุชุฑุชูุจ ุงูููุทูู ุจุฏูุงู ูู ุงูุชุฑุชูุจ ุงูุฃุจุฌุฏู
            const classes = sortClassesLogically(Object.keys(studentsByClass));
            
            // Main class select
            classSelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงูุตู ูุงููุตู --</option>';
            classes.forEach(c => {
                const option = document.createElement('option');
                option.value = c;
                option.textContent = c;
                classSelect.appendChild(option);
            });
            
            // Filter selects
            if (filterClassSelect) {
                filterClassSelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงููุตู --</option>';
                classes.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c;
                    option.textContent = c;
                    filterClassSelect.appendChild(option);
                });
            }
            
            if (filterClassOnlySelect) {
                filterClassOnlySelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงููุตู --</option>';
                classes.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c;
                    option.textContent = c;
                    filterClassOnlySelect.appendChild(option);
                });
            }
        }

        function populateClasses() {  
            const classSelect = document.getElementById('classSelect');  
            const filterClassSelect = document.getElementById('filterClassSelect');  
            const filterClassOnlySelect = document.getElementById('filterClassOnlySelect');  
            
const classes = sortClassesLogically(Object.keys(studentsByClass));
            
            // Main class select  
            classSelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงูุตู ูุงููุตู --</option>';  
            classes.forEach(c => {  
                const option = document.createElement('option');  
                option.value = c;  
                option.textContent = c;  
                classSelect.appendChild(option);  
            });  
            
            // Filter selects  
            if (filterClassSelect) {  
                filterClassSelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงููุตู --</option>';  
                classes.forEach(c => {  
                    const option = document.createElement('option');  
                    option.value = c;  
                    option.textContent = c;  
                    filterClassSelect.appendChild(option);  
                });  
            }  
            
            if (filterClassOnlySelect) {  
                filterClassOnlySelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงููุตู --</option>';  
                classes.forEach(c => {  
                    const option = document.createElement('option');  
                    option.value = c;  
                    option.textContent = c;  
                    filterClassOnlySelect.appendChild(option);  
                });  
            }  
        }  

        // โจ MODIFIED: ุฏุนู ุงูุงุฎุชูุงุฑ ุงููุชุนุฏุฏ  
        function loadStudents() {  
            const selectedClass = document.getElementById('classSelect').value;  
            const studentSelect = document.getElementById('studentSelect');  
            const texts = GENDER_TEXTS[getSchoolType()];  
            
            studentSelect.innerHTML = `<option value="">-- ${texts.selectStudent} --</option>`;  
            
            if (selectedClass && studentsByClass[selectedClass]) {  
                studentsByClass[selectedClass].forEach(student => {  
                    const option = document.createElement('option');  
                    option.value = student;  
                    option.textContent = student;  
                    studentSelect.appendChild(option);  
                });  
            }  
            
            // โจ NEW: ุชุญุฏูุซ ูุงุฆูุฉ ุงูุงุฎุชูุงุฑ ุงููุชุนุฏุฏ ุฃูุถุงู  
            if (isMultiSelectMode) {  
                populateMultiSelectStudents(selectedClass);  
            }  
        }  

        function loadFilterStudents() {  
            const selectedClass = document.getElementById('filterClassSelect').value;  
            const studentSelect = document.getElementById('filterStudentSelect');  
            const texts = GENDER_TEXTS[getSchoolType()];  
            
            studentSelect.innerHTML = `<option value="">-- ${texts.selectStudent} --</option>`;  
            
            if (selectedClass && studentsByClass[selectedClass]) {  
                studentsByClass[selectedClass].forEach(student => {  
                    const option = document.createElement('option');  
                    option.value = student;  
                    option.textContent = student;  
                    studentSelect.appendChild(option);  
                });  
            }  
        }  

        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  
        //                    BEHAVIOR SELECTION  
        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  
        
        function selectDegree(degree) {  
            // Remove previous selection  
            document.querySelectorAll('[id^="degree-"]').forEach(el => {  
                el.classList.remove('selected-degree');  
            });  
            
            // Add selection to clicked  
            document.getElementById(`degree-${degree}`).classList.add('selected-degree');  
            selectedDegree = degree;  
            
            // Show behavior type dropdown  
            document.getElementById('behaviorTypeContainer').style.display = 'block';  
            
            // Populate behavior types  
            const behaviorSelect = document.getElementById('behaviorType');  
            behaviorSelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ููุน ุงูุณููู --</option>';  
            
            const behaviors = behaviorsByDegree[degree];  
            behaviors.forEach(b => {  
                const option = document.createElement('option');  
                option.value = JSON.stringify(b);  
                option.textContent = `${b.name} (+${b.points} ุฏุฑุฌุงุช)`;  
                behaviorSelect.appendChild(option);  
            });  
            
            // Show/hide custom points  
            if (degree === 'other') {  
                document.getElementById('customPointsContainer').style.display = 'block';  
            } else {  
                document.getElementById('customPointsContainer').style.display = 'none';  
            }  
        }  

        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  
        //                    SAVE OPERATIONS  
        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  
        
        // โจ MODIFIED: ุฏุนู ุงูุงุฎุชูุงุฑ ุงููุชุนุฏุฏ  
        function saveOperation() {  
            const selectedStudents = getSelectedStudents();  
            const className = document.getElementById('classSelect').value;  
            const behaviorTypeValue = document.getElementById('behaviorType').value;  
            const note = document.getElementById('noteInput').value;  
            const sender = getSenderName();  
            const texts = GENDER_TEXTS[getSchoolType()];  
            
            // Validation  
            if (!className) {  
                alert('โ๏ธ ูุฑุฌู ุงุฎุชูุงุฑ ุงูุตู ูุงููุตู');  
                return;  
            }  
            
            if (selectedStudents.length === 0) {  
                alert(`โ๏ธ ูุฑุฌู ุงุฎุชูุงุฑ ${texts.student}`);  
                return;  
            }  
            
            if (!behaviorTypeValue) {  
                alert('โ๏ธ ูุฑุฌู ุงุฎุชูุงุฑ ููุน ุงูุณููู');  
                return;  
            }  
            
            // Handle custom points for "other" category  
            let behaviorType = JSON.parse(behaviorTypeValue);  
            if (selectedDegree === 'other') {  
                const customPoints = parseInt(document.getElementById('customPoints').value);  
                if (!customPoints || customPoints < 1 || customPoints > 6) {  
                    alert('โ๏ธ ูุฑุฌู ุฅุฏุฎุงู ุนุฏุฏ ุฏุฑุฌุงุช ุตุญูุญ (ูู 1 ุฅูู 6)');  
                    return;  
                }  
                behaviorType.points = customPoints;  
            }  
            
            // Get current behaviors  
            const behaviors = JSON.parse(localStorage.getItem(STORAGE_KEYS.BEHAVIORS) || '[]');  
            
            // Get current Hijri date  
            const hijriDate = new Date().toLocaleDateString('ar-SA');  
            
            // โจ MODIFIED: ุญูุธ ุณุฌู ููู ุทุงูุจ ูุญุฏุฏ  
            selectedStudents.forEach(studentName => {  
                const newBehavior = {  
                    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),  
                    date: hijriDate,  
                    class: className,  
                    student: studentName,  
                    behaviorType: behaviorType,  
                    note: note,  
                    sender: sender,  
                    timestamp: Date.now()  
                };  
                
                behaviors.push(newBehavior);  
            });  
            
            // Save to localStorage  
            localStorage.setItem(STORAGE_KEYS.BEHAVIORS, JSON.stringify(behaviors));  
            
            // Update statistics  
            updateAllStatistics();  
            
            // Show success message  
            if (selectedStudents.length === 1) {  
                alert(`โ ุชู ุญูุธ ุงูุณููู ุงููููุฒ ${texts.forStudent}: ${selectedStudents[0]}`);  
            } else {  
                alert(`โ ุชู ุญูุธ ุงูุณููู ุงููููุฒ ูู ${selectedStudents.length} ${texts.students}`);  
            }  
            
            // Reset form  
            resetForm();  
        }  

        // โจ MODIFIED: ุฏุนู ุงูุงุฎุชูุงุฑ ุงููุชุนุฏุฏ ููุญูุธ ูุงูุทุจุงุนุฉ  
        function saveAndPrint() {  
            const selectedStudents = getSelectedStudents();  
            const className = document.getElementById('classSelect').value;  
            const behaviorTypeValue = document.getElementById('behaviorType').value;  
            const note = document.getElementById('noteInput').value;  
            const sender = getSenderName();  
            const texts = GENDER_TEXTS[getSchoolType()];  
            
            // Validation  
            if (!className) {  
                alert('โ๏ธ ูุฑุฌู ุงุฎุชูุงุฑ ุงูุตู ูุงููุตู');  
                return;  
            }  
            
            if (selectedStudents.length === 0) {  
                alert(`โ๏ธ ูุฑุฌู ุงุฎุชูุงุฑ ${texts.student}`);  
                return;  
            }  
            
            if (!behaviorTypeValue) {  
                alert('โ๏ธ ูุฑุฌู ุงุฎุชูุงุฑ ููุน ุงูุณููู');  
                return;  
            }  
            
            // Handle custom points  
            let behaviorType = JSON.parse(behaviorTypeValue);  
            if (selectedDegree === 'other') {  
                const customPoints = parseInt(document.getElementById('customPoints').value);  
                if (!customPoints || customPoints < 1 || customPoints > 6) {  
                    alert('โ๏ธ ูุฑุฌู ุฅุฏุฎุงู ุนุฏุฏ ุฏุฑุฌุงุช ุตุญูุญ (ูู 1 ุฅูู 6)');  
                    return;  
                }  
                behaviorType.points = customPoints;  
            }  
            
            // Get current behaviors  
            const behaviors = JSON.parse(localStorage.getItem(STORAGE_KEYS.BEHAVIORS) || '[]');  
            const hijriDate = new Date().toLocaleDateString('ar-SA');  
            
            // Save and collect for printing  
            const savedBehaviors = [];  
            
            selectedStudents.forEach(studentName => {  
                const newBehavior = {  
                    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),  
                    date: hijriDate,  
                    class: className,  
                    student: studentName,  
                    behaviorType: behaviorType,  
                    note: note,  
                    sender: sender,  
                    timestamp: Date.now()  
                };  
                
                behaviors.push(newBehavior);  
                savedBehaviors.push(newBehavior);  
            });  
            
            // Save to localStorage  
            localStorage.setItem(STORAGE_KEYS.BEHAVIORS, JSON.stringify(behaviors));  
            
            // Update statistics  
            updateAllStatistics();  
            
            // Print certificates for all selected students  
            printMultipleCertificates(savedBehaviors);  
            
            // Reset form  
            resetForm();  
        }  

        // โจ NEW: ุทุจุงุนุฉ ุดูุงุฏุงุช ูุชุนุฏุฏุฉ  
        function printMultipleCertificates(behaviors) {  
            const schoolName = document.getElementById('schoolNameInput').value || 'ุงููุฏุฑุณุฉ';  
            const texts = GENDER_TEXTS[getSchoolType()];  
            
            let certificatesHTML = '';  
            
            behaviors.forEach((behavior, index) => {  
                const behaviorType = typeof behavior.behaviorType === 'string'   
                    ? JSON.parse(behavior.behaviorType)   
                    : behavior.behaviorType;  
                
                // ุญุณุงุจ ูุฌููุน ููุงุท ุงูุทุงูุจ ุจุนุฏ ูุฐู ุงูุนูููุฉ  
                const allBehaviors = JSON.parse(localStorage.getItem(STORAGE_KEYS.BEHAVIORS) || '[]');  
                const totalPoints = getStudentTotalPoints(behavior.student, allBehaviors);  
                const starBadge = totalPoints >= 20 ? 'โญ' : '';  
                
                certificatesHTML += `  
                    <div style="page-break-after: ${index < behaviors.length - 1 ? 'always' : 'auto'}; padding: 40px; font-family: 'Tajawal', sans-serif;">  
                        <div style="border: 3px solid #2563eb; border-radius: 15px; padding: 30px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">  
                            
                            <div style="text-align: center; border-bottom: 2px solid #2563eb; padding-bottom: 20px; margin-bottom: 20px;">  
                                <h1 style="color: #1e40af; font-size: 28px; margin: 0;">๐ ุดูุงุฏุฉ ุงูุณููู ุงููููุฒ ๐</h1>  
                                <p style="color: #6b7280; margin-top: 10px;">${schoolName}</p>  
                            </div>  
                            
                            <div style="text-align: center; margin: 30px 0;">  
                                <p style="font-size: 18px; color: #374151; margin-bottom: 10px;">ุชุดูุฏ ุฅุฏุงุฑุฉ ุงููุฏุฑุณุฉ ุจุฃู ${texts.student}:</p>  
                                <h2 style="font-size: 32px; color: #059669; margin: 15px 0; padding: 15px; background: #ecfdf5; border-radius: 10px; display: inline-block;">  
                                    ${behavior.student} ${starBadge}  
                                </h2>  
                                <p style="font-size: 16px; color: #6b7280;">ุงููุตู: ${behavior.class}</p>  
                            </div>  
                            
                            <div style="background: #f0fdf4; border: 2px solid #22c55e; border-radius: 10px; padding: 20px; margin: 20px 0; text-align: center;">  
                                <p style="font-size: 16px; color: #374151; margin-bottom: 10px;">ูุฏ ุชููุฒ ุจุงูุณููู ุงูุชุงูู:</p>  
                                <h3 style="font-size: 20px; color: #166534; margin: 10px 0;">${behaviorType.name}</h3>  
                                <div style="margin-top: 15px;">  
                                    <span style="background: #fbbf24; color: #92400e; padding: 8px 20px; border-radius: 20px; font-weight: bold; font-size: 18px;">  
                                        +${behaviorType.points} ุฏุฑุฌุงุช  
                                    </span>  
                                </div>  
                                ${behavior.note ? `<p style="margin-top: 15px; color: #6b7280; font-size: 14px;">ููุงุญุธุงุช: ${behavior.note}</p>` : ''}  
                            </div>  
                            
                            ${totalPoints >= 20 ? `  
                            <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 10px; padding: 15px; margin: 20px 0; text-align: center;">  
                                <span style="font-size: 24px;">โญ</span>  
                                <span style="font-size: 16px; color: #92400e; font-weight: bold;">  
                                    ุญุงุตู ุนูู ุดุงุฑุฉ ุงูุชููุฒ (${totalPoints} ุฏุฑุฌุฉ)  
                                </span>  
                                <span style="font-size: 24px;">โญ</span>  
                            </div>  
                            ` : ''}  
                            
                            <div style="text-align: center; margin: 30px 0;">  
                                <p style="font-size: 16px; color: #059669; font-weight: bold;">${texts.prayerFor} ุจุฏูุงู ุงูุชูููู ูุงููุฌุงุญ</p>  
                            </div>  
                            
                            <div style="display: flex; justify-content: space-between; margin-top: 30px; padding-top: 20px; border-top: 1px dashed #d1d5db;">  
                                <div style="text-align: center;">  
                                    <p style="color: #6b7280; font-size: 14px;">ุงูุชุงุฑูุฎ</p>  
                                    <p style="font-weight: bold;">${behavior.date}</p>  
                                </div>  
                                <div style="text-align: center;">  
                                    <p style="color: #6b7280; font-size: 14px;">ุงูุฑุงุตุฏ</p>  
                                    <p style="font-weight: bold;">${behavior.sender}</p>  
                                </div>  
                                <div style="text-align: center;">  
                                    <p style="color: #6b7280; font-size: 14px;">ุงูุชูููุน</p>  
                                    <p>____________</p>  
                                </div>  
                            </div>  
                        </div>  
                    </div>  
                `;  
            });  
            
            const printWindow = window.open('', '_blank');  
            printWindow.document.write(`  
                <!DOCTYPE html>  
                <html lang="ar" dir="rtl">  
                <head>  
                    <meta charset="UTF-8">  
                    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">  
                </head>  
                <body style="margin: 0; padding: 0;">  
                    ${certificatesHTML}  
                </body>  
                </html>  
            `);  
            printWindow.document.close();  
            setTimeout(() => printWindow.print(), 500);  
        }  

        function getSenderName() {  
            const senderSelect = document.getElementById('senderSelect');  
            if (senderSelect.value === 'custom') {  
                return document.getElementById('customSenderInput').value || 'ุบูุฑ ูุญุฏุฏ';  
            }  
            return senderSelect.value;  
        }  

        function resetForm() {  
            document.getElementById('studentSelect').value = '';  
            document.getElementById('behaviorType').value = '';  
            document.getElementById('noteInput').value = '';  
            document.getElementById('customPoints').value = '';  
            
            // Reset degree selection  
            document.querySelectorAll('[id^="degree-"]').forEach(el => {  
                el.classList.remove('selected-degree');  
            });  
            
            document.getElementById('behaviorTypeContainer').style.display = 'none';  
            document.getElementById('customPointsContainer').style.display = 'none';  
            
            selectedDegree = null;  
            
            // โจ NEW: ุฅูุบุงุก ุชุญุฏูุฏ ุงูุทูุงุจ ูู ูุถุน ุงูุงุฎุชูุงุฑ ุงููุชุนุฏุฏ  
            if (isMultiSelectMode) {  
                deselectAllStudents();  
            }  
        }  

        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  
        //                    DISPLAY OPERATIONS  
        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  
        
        // โจ MODIFIED: ุฏุนู ููุชุฑ ุงูุชุงุฑูุฎ  
        function displayOperations() {  
            let behaviors = JSON.parse(localStorage.getItem(STORAGE_KEYS.BEHAVIORS) || '[]');  
            
            // โจ NEW: ุชุทุจูู ููุชุฑ ุงูุชุงุฑูุฎ ุฅุฐุง ูุงู ูุดุทุงู  
            if (activeDateFilter) {  
                behaviors = filterBehaviorsByDate(behaviors, activeDateFilter.from, activeDateFilter.to);  
                
                // ุนุฑุถ ูุคุดุฑ ุงูููุชุฑ ุงููุดุท  
                const badge = document.getElementById('activeDateFilterBadge');  
                const text = document.getElementById('activeDateFilterText');  
                badge.classList.remove('hidden');  
                
                let filterText = 'ุงูููุชุฑ ุงููุดุท: ';  
                if (activeDateFilter.fromStr && activeDateFilter.toStr) {  
                    filterText += `ูู ${activeDateFilter.fromStr} ุฅูู ${activeDateFilter.toStr}`;  
                } else if (activeDateFilter.fromStr) {  
                    filterText += `ูู ${activeDateFilter.fromStr}`;  
                } else {  
                    filterText += `ุญุชู ${activeDateFilter.toStr}`;  
                }  
                text.textContent = filterText;  
            } else {  
                document.getElementById('activeDateFilterBadge').classList.add('hidden');  
            }  
            
            displayFilteredOperations(behaviors, 'ุงูุณููููุงุช ุงููุณุฌูุฉ');  
        }  

        // โจ ุฏุงูุฉ ุนุฑุถ ุงูุณููููุงุช ูุน ุฌููุน ุงูุฅุฌุฑุงุกุงุช
        function displayFilteredOperations(behaviors, title) {
            const container = document.getElementById('operationsContainer');
            const tbody = document.getElementById('operationsTableBody');
            const titleElement = document.getElementById('operationsTitle');
            const countElement = document.getElementById('operationsCount');
            const texts = GENDER_TEXTS[getSchoolType()];
            
            titleElement.textContent = title;
            container.classList.remove('hidden');
            
            if (behaviors.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="py-4 text-center text-gray-500">ูุง ุชูุฌุฏ ุณููููุงุช ูุณุฌูุฉ</td></tr>`;
                countElement.textContent = '0';
                return;
            }
            
            // Sort by date (newest first)
            behaviors.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            
            // ุญุณุงุจ ูุฌููุน ุงูููุงุท ููู ุทุงูุจ
            const allBehaviors = JSON.parse(localStorage.getItem(STORAGE_KEYS.BEHAVIORS) || '[]');
            
            tbody.innerHTML = '';
            behaviors.forEach(b => {
                const behaviorType = typeof b.behaviorType === 'string' 
                    ? JSON.parse(b.behaviorType) 
                    : b.behaviorType;
                
                // ุงูุชุญูู ูู ุงุณุชุญูุงู ุงููุฌูุฉ
                const totalPoints = getStudentTotalPoints(b.student, allBehaviors);
                const starBadge = totalPoints >= 20 ? ' <span class="star-badge">โญ</span>' : '';
                
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-2 text-sm">${b.date}</td>
                    <td class="py-3 px-2 text-sm">${b.class}</td>
                    <td class="py-3 px-2 font-semibold">${b.student}${starBadge}</td>
                    <td class="py-3 px-2 text-xs">${behaviorType.name}</td>
                    <td class="py-3 px-2 text-center">
                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-sm font-bold">+${behaviorType.points}</span>
                    </td>
                    <td class="py-3 px-2 text-sm">${b.sender}</td>
                    <td class="py-3 px-2 text-center">
                        <div class="flex items-center justify-center gap-1">
                            <button onclick="printSingleCertificate('${b.id}')" 
                                    class="p-1 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded" 
                                    title="ุทุจุงุนุฉ ุงูุดูุงุฏุฉ">
                                ๐จ๏ธ
                            </button>
                            <button onclick="sendWhatsApp('${b.id}')" 
                                    class="p-1 text-green-600 hover:text-green-800 hover:bg-green-50 rounded" 
                                    title="ุฅุฑุณุงู ูุงุชุณุงุจ">
                                ๐ฑ
                            </button>
                            <button onclick="deleteOperation('${b.id}')" 
                                    class="p-1 text-red-600 hover:text-red-800 hover:bg-red-50 rounded" 
                                    title="ุญุฐู">
                                ๐๏ธ
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            countElement.textContent = behaviors.length;
            
            // Scroll to operations
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function closeOperations() {  
            document.getElementById('operationsContainer').classList.add('hidden');  
        }  

        function deleteOperation(id) {  
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุณูููุ')) return;  
            
            let behaviors = JSON.parse(localStorage.getItem(STORAGE_KEYS.BEHAVIORS) || '[]');  
            behaviors = behaviors.filter(b => b.id !== id);  
            localStorage.setItem(STORAGE_KEYS.BEHAVIORS, JSON.stringify(behaviors));  
            
            updateAllStatistics();  
            displayOperations();  
        }  

        function clearOperations() {  
            if (!confirm('โ๏ธ ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุฌููุน ุงูุณุฌูุงุชุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.')) return;  
            
            localStorage.setItem(STORAGE_KEYS.BEHAVIORS, '[]');  
            updateAllStatistics();  
            closeOperations();  
            alert('โ ุชู ุญุฐู ุฌููุน ุงูุณุฌูุงุช');  
        }  


        // ๐จ๏ธ ุทุจุงุนุฉ ุดูุงุฏุฉ ูุฑุฏูุฉ
        function printSingleCertificate(behaviorId) {
            const behaviors = JSON.parse(localStorage.getItem(STORAGE_KEYS.BEHAVIORS) || '[]');
            const behavior = behaviors.find(b => b.id === behaviorId);
            
            if (!behavior) {
                alert('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุณููู');
                return;
            }
            
            printMultipleCertificates([behavior]);
        }

        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  
        //                    STATISTICS & CHARTS  
        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  
        
        // โจ MODIFIED: ุฅุถุงูุฉ ุฅุญุตุงุฆูุฉ ุงููุชููุฒูู (20+ ุฏุฑุฌุฉ)  
        function updateAllStatistics() {  
            const behaviors = JSON.parse(localStorage.getItem(STORAGE_KEYS.BEHAVIORS) || '[]');  
            const texts = GENDER_TEXTS[getSchoolType()];  
            
            // General stats  
            const totalBehaviors = behaviors.length;  
            document.getElementById('totalBehaviors').textContent = totalBehaviors;  
            document.getElementById('sidebarTotal').textContent = totalBehaviors;  
            
            // Unique students  
            const uniqueStudents = new Set(behaviors.map(b => b.student));  
            document.getElementById('totalStudents').textContent = uniqueStudents.size;  
            document.getElementById('sidebarStudents').textContent = uniqueStudents.size;  
            
            // Total points  
            const totalPoints = behaviors.reduce((sum, b) => {  
                const behaviorType = typeof b.behaviorType === 'string'   
                    ? JSON.parse(b.behaviorType)   
                    : b.behaviorType;  
                return sum + (behaviorType.points || 0);  
            }, 0);  
            document.getElementById('totalPoints').textContent = totalPoints;  
            document.getElementById('sidebarPoints').textContent = totalPoints;  
            
            // Average  
            const average = uniqueStudents.size > 0   
                ? (totalBehaviors / uniqueStudents.size).toFixed(1)   
                : '0';  
            document.getElementById('avgBehaviors').textContent = average;  
            
            // โจ NEW: ุญุณุงุจ ุนุฏุฏ ุงูุญุงุตููู ุนูู 20+ ุฏุฑุฌุฉ  
            const starStudents = getStarStudents();  
            document.getElementById('starStudentsCount').textContent = starStudents.length;  
            document.getElementById('sidebarStarCount').textContent = starStudents.length;  
            
            // Update charts  
            updateBehaviorsByDegreeChart(behaviors);  
            updateBehaviorsByClassChart(behaviors);  
            
            // Update tables  
            updateCommonBehaviorsList(behaviors);  
            updateTopStudentsList(behaviors);  
        }  

        function updateBehaviorsByDegreeChart(behaviors) {  
            const canvas = document.getElementById('behaviorsByDegreeChart');  
            const ctx = canvas.getContext('2d');  
            
            if (window.degreeChartInstance) {  
                window.degreeChartInstance.destroy();  
            }  
            
            const degreeStats = { 6: 0, 4: 0, 2: 0, other: 0 };  
            
            behaviors.forEach(b => {  
                const behaviorType = typeof b.behaviorType === 'string'   
                    ? JSON.parse(b.behaviorType)   
                    : b.behaviorType;  
                
                const points = behaviorType.points;  
                if (points === 6) degreeStats[6]++;  
                else if (points === 4) degreeStats[4]++;  
                else if (points === 2) degreeStats[2]++;  
                else degreeStats.other++;  
            });  
            
            window.degreeChartInstance = new Chart(ctx, {  
                type: 'pie',  
                data: {  
                    labels: ['6 ุฏุฑุฌุงุช', '4 ุฏุฑุฌุงุช', 'ุฏุฑุฌุชุงู', 'ุฃุฎุฑู'],  
                    datasets: [{  
                        data: [degreeStats[6], degreeStats[4], degreeStats[2], degreeStats.other],  
                        backgroundColor: ['#fbbf24', '#86efac', '#bfdbfe', '#e9d5ff'],  
                        borderColor: ['#f59e0b', '#22c55e', '#3b82f6', '#a855f7'],  
                        borderWidth: 2  
                    }]  
                },  
                options: {  
                    responsive: true,  
                    maintainAspectRatio: false,  
                    plugins: {  
                        legend: {  
                            position: 'bottom',  
                            labels: {  
                                font: { family: 'Tajawal', size: 12 },  
                                padding: 10  
                            }  
                        }  
                    }  
                }  
            });  
        }  

        function updateBehaviorsByClassChart(behaviors) {  
            const canvas = document.getElementById('behaviorsByClassChart');  
            const ctx = canvas.getContext('2d');  
            
            if (window.classChartInstance) {  
                window.classChartInstance.destroy();  
            }  
            
            const classStats = {};  
            behaviors.forEach(b => {  
                classStats[b.class] = (classStats[b.class] || 0) + 1;  
            });  
            
            const sortedClasses = Object.entries(classStats)  
                .sort((a, b) => b[1] - a[1])  
                .slice(0, 6);  
            
            if (sortedClasses.length === 0) {  
                ctx.font = '14px Tajawal';  
                ctx.textAlign = 'center';  
                ctx.fillStyle = '#6b7280';  
                ctx.fillText('ูุง ุชูุฌุฏ ุจูุงูุงุช', canvas.width / 2, canvas.height / 2);  
                return;  
            }  
            
            window.classChartInstance = new Chart(ctx, {  
                type: 'bar',  
                data: {  
                    labels: sortedClasses.map(c => c[0]),  
                    datasets: [{  
                        label: 'ุนุฏุฏ ุงูุณููููุงุช',  
                        data: sortedClasses.map(c => c[1]),  
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',  
                        borderColor: 'rgba(59, 130, 246, 1)',  
                        borderWidth: 2  
                    }]  
                },  
                options: {  
                    responsive: true,  
                    maintainAspectRatio: false,  
                    plugins: { legend: { display: false } },  
                    scales: {  
                        y: { beginAtZero: true, ticks: { font: { family: 'Tajawal' }, stepSize: 1 } },  
                        x: { ticks: { font: { family: 'Tajawal', size: 11 } } }  
                    }  
                }  
            });  
        }  

        function updateCommonBehaviorsList(behaviors) {  
            const tbody = document.getElementById('commonBehaviorsList');  
            
            if (behaviors.length === 0) {  
                tbody.innerHTML = '<tr><td colspan="3" class="py-2 px-3 text-center text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>';  
                return;  
            }  
            
            const behaviorCounts = {};  
            behaviors.forEach(b => {  
                const behaviorType = typeof b.behaviorType === 'string'   
                    ? JSON.parse(b.behaviorType)   
                    : b.behaviorType;  
                const name = behaviorType.name;  
                behaviorCounts[name] = (behaviorCounts[name] || 0) + 1;  
            });  
            
            const sortedBehaviors = Object.entries(behaviorCounts)  
                .sort((a, b) => b[1] - a[1])  
                .slice(0, 5);  
            
            tbody.innerHTML = '';  
            sortedBehaviors.forEach(([name, count]) => {  
                const percentage = ((count / behaviors.length) * 100).toFixed(1);  
                const row = document.createElement('tr');  
                row.className = 'border-b';  
                row.innerHTML = `  
                    <td class="py-2 px-3 text-xs">${name}</td>  
                    <td class="py-2 px-3 text-center font-bold text-blue-600">${count}</td>  
                    <td class="py-2 px-3 text-center text-xs">${percentage}%</td>  
                `;  
                tbody.appendChild(row);  
            });  
        }  

        // โจ MODIFIED: ุฅุถุงูุฉ ุดุงุฑุฉ ุงููุฌูุฉ  
        function updateTopStudentsList(behaviors) {  
            const tbody = document.getElementById('topStudentsList');  
            
            if (behaviors.length === 0) {  
                tbody.innerHTML = '<tr><td colspan="4" class="py-2 px-3 text-center text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>';  
                return;  
            }  
            
            const studentStats = {};  
            behaviors.forEach(b => {  
                if (!studentStats[b.student]) {  
                    studentStats[b.student] = { class: b.class, count: 0, points: 0 };  
                }  
                studentStats[b.student].count++;  
                
                const behaviorType = typeof b.behaviorType === 'string'   
                    ? JSON.parse(b.behaviorType)   
                    : b.behaviorType;  
                studentStats[b.student].points += (behaviorType.points || 0);  
            });  
            
            const sortedStudents = Object.entries(studentStats)  
                .sort((a, b) => b[1].points - a[1].points)  
                .slice(0, 5);  
            
            tbody.innerHTML = '';  
            sortedStudents.forEach(([name, data]) => {  
                // โจ NEW: ุฅุถุงูุฉ ุดุงุฑุฉ ุงููุฌูุฉ  
                const starBadge = data.points >= 20 ? ' โญ' : '';  
                
                const row = document.createElement('tr');  
                row.className = 'border-b';  
                row.innerHTML = `  
                    <td class="py-2 px-3 text-xs font-semibold">${name}${starBadge}</td>  
                    <td class="py-2 px-3 text-xs">${data.class}</td>  
                    <td class="py-2 px-3 text-center font-bold text-blue-600">${data.count}</td>  
                    <td class="py-2 px-3 text-center font-bold text-green-600">+${data.points}</td>  
                `;  
                tbody.appendChild(row);  
            });  
        }  

        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  
        //                    ADVANCED REPORTS  
        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  
        
        // โจ MODIFIED: ุฏุนู ููุชุฑ ุงูุชุงุฑูุฎ  
        function filterByStudent() {  
            const selectedStudent = document.getElementById('filterStudentSelect').value;  
            const fromDate = document.getElementById('studentReportDateFrom').value;  
            const toDate = document.getElementById('studentReportDateTo').value;  
            const texts = GENDER_TEXTS[getSchoolType()];  
            
            if (!selectedStudent) {  
                alert(`ูุฑุฌู ุงุฎุชูุงุฑ ${texts.student}`);  
                return;  
            }  
            
            let behaviors = JSON.parse(localStorage.getItem(STORAGE_KEYS.BEHAVIORS) || '[]');  
            let filtered = behaviors.filter(b => b.student === selectedStudent);  
            
            // โจ NEW: ุชุทุจูู ููุชุฑ ุงูุชุงุฑูุฎ  
            if (fromDate || toDate) {  
                const from = fromDate ? gregorianToHijriApprox(fromDate) : null;  
                const to = toDate ? gregorianToHijriApprox(toDate) : null;  
                filtered = filterBehaviorsByDate(filtered, from, to);  
            }  
            
            if (filtered.length === 0) {  
                alert(`ูุง ุชูุฌุฏ ุณููููุงุช ูุณุฌูุฉ ${texts.forStudent} ูุฐุง`);  
                return;  
            }  
            
            closeFilterStudentModal();  
            displayFilteredOperations(filtered, `ุชูุฑูุฑ ${texts.student}: ${selectedStudent}`);  
        }  

        // โจ MODIFIED: ุฏุนู ููุชุฑ ุงูุชุงุฑูุฎ  
        function filterByClass() {  
            const selectedClass = document.getElementById('filterClassOnlySelect').value;  
            const fromDate = document.getElementById('classReportDateFrom').value;  
            const toDate = document.getElementById('classReportDateTo').value;  
            
            if (!selectedClass) {  
                alert("ูุฑุฌู ุงุฎุชูุงุฑ ุงููุตู");  
                return;  
            }  
            
            let behaviors = JSON.parse(localStorage.getItem(STORAGE_KEYS.BEHAVIORS) || '[]');  
            let filtered = behaviors.filter(b => b.class === selectedClass);  
            
            // โจ NEW: ุชุทุจูู ููุชุฑ ุงูุชุงุฑูุฎ  
            if (fromDate || toDate) {  
                const from = fromDate ? gregorianToHijriApprox(fromDate) : null;  
                const to = toDate ? gregorianToHijriApprox(toDate) : null;  
                filtered = filterBehaviorsByDate(filtered, from, to);  
            }  
            
            if (filtered.length === 0) {  
                alert("ูุง ุชูุฌุฏ ุณููููุงุช ูุณุฌูุฉ ููุฐุง ุงููุตู");  
                return;  
            }  
            
            closeFilterClassModal();  
            displayFilteredOperations(filtered, `ุชูุฑูุฑ ุงููุตู: ${selectedClass}`);  
        }  

        // โจ MODIFIED: ุฏุนู ููุชุฑ ุงูุชุงุฑูุฎ ูุงููุตูุต ุงูุฏููุงููููุฉ  
        function printStudentReport() {  
            const selectedStudent = document.getElementById('filterStudentSelect').value;  
            const fromDate = document.getElementById('studentReportDateFrom').value;  
            const toDate = document.getElementById('studentReportDateTo').value;  
            const texts = GENDER_TEXTS[getSchoolType()];  
            
            if (!selectedStudent) {  
                alert(`ูุฑุฌู ุงุฎุชูุงุฑ ${texts.student}`);  
                return;  
            }  
            
            let behaviors = JSON.parse(localStorage.getItem(STORAGE_KEYS.BEHAVIORS) || '[]');  
            let filtered = behaviors.filter(b => b.student === selectedStudent);  
            
            // โจ NEW: ุชุทุจูู ููุชุฑ ุงูุชุงุฑูุฎ  
            if (fromDate || toDate) {  
                const from = fromDate ? gregorianToHijriApprox(fromDate) : null;  
                const to = toDate ? gregorianToHijriApprox(toDate) : null;  
                filtered = filterBehaviorsByDate(filtered, from, to);  
            }  
            
            if (filtered.length === 0) {  
                alert(`ูุง ุชูุฌุฏ ุณููููุงุช ูุณุฌูุฉ ${texts.forStudent} ูุฐุง`);  
                return;  
            }  
            
            generateStudentReport(selectedStudent, filtered);  
        }  

        // โจ MODIFIED: ุฏุนู ููุชุฑ ุงูุชุงุฑูุฎ  
        function printClassReport() {  
            const selectedClass = document.getElementById('filterClassOnlySelect').value;  
            const fromDate = document.getElementById('classReportDateFrom').value;  
            const toDate = document.getElementById('classReportDateTo').value;  
            
            if (!selectedClass) {  
                alert("ูุฑุฌู ุงุฎุชูุงุฑ ุงููุตู");  
                return;  
            }  
            
            let behaviors = JSON.parse(localStorage.getItem(STORAGE_KEYS.BEHAVIORS) || '[]');  
            let filtered = behaviors.filter(b => b.class === selectedClass);  
            
            // โจ NEW: ุชุทุจูู ููุชุฑ ุงูุชุงุฑูุฎ  
            if (fromDate || toDate) {  
                const from = fromDate ? gregorianToHijriApprox(fromDate) : null;  
                const to = toDate ? gregorianToHijriApprox(toDate) : null;  
                filtered = filterBehaviorsByDate(filtered, from, to);  
            }  
            
            if (filtered.length === 0) {  
                alert("ูุง ุชูุฌุฏ ุณููููุงุช ูุณุฌูุฉ ููุฐุง ุงููุตู");  
                return;  
            }  
            
            generateClassReport(selectedClass, filtered);  
        }  

        // โจ MODIFIED: ุงุณุชุฎุฏุงู ุงููุตูุต ุงูุฏููุงููููุฉ  
        function generateStudentReport(studentName, behaviors) {  
            const texts = GENDER_TEXTS[getSchoolType()];  
            const totalPoints = behaviors.reduce((sum, b) => {  
                const behaviorType = typeof b.behaviorType === 'string'   
                    ? JSON.parse(b.behaviorType)   
                    : b.behaviorType;  
                return sum + (behaviorType.points || 0);  
            }, 0);  
            
            const starBadge = totalPoints >= 20 ? 'โญ' : '';  
            
            let tableRows = '';  
            behaviors.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));  
            
            behaviors.forEach((b, index) => {  
                const behaviorType = typeof b.behaviorType === 'string'   
                    ? JSON.parse(b.behaviorType)   
                    : b.behaviorType;  
                
                tableRows += `  
                    <tr style="border-bottom: 1px solid #e5e7eb;">  
                        <td style="padding: 12px; text-align: center;">${index + 1}</td>  
                        <td style="padding: 12px;">${b.date}</td>  
                        <td style="padding: 12px;">${behaviorType.name}</td>  
                        <td style="padding: 12px; text-align: center; font-weight: bold; color: #059669;">+${behaviorType.points}</td>  
                        <td style="padding: 12px; font-size: 14px;">${b.sender}</td>  
                    </tr>  
                `;  
            });  
            
            const reportHTML = `  
                <!DOCTYPE html>  
                <html lang="ar" dir="rtl">  
                <head>  
                    <meta charset="UTF-8">  
                    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">  
                    <style>  
                        body { font-family: 'Tajawal', sans-serif; padding: 40px; }  
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #2563eb; padding-bottom: 20px; }  
                        .header h1 { color: #1e40af; font-size: 28px; margin: 10px 0; }  
                        .summary { background: #f0fdf4; border: 2px solid #22c55e; padding: 20px; border-radius: 10px; margin: 20px 0; }  
                        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px; }  
                        .summary-item { text-align: center; background: white; padding: 15px; border-radius: 8px; }  
                        .summary-value { font-size: 28px; font-weight: bold; color: #059669; }  
                        .summary-label { font-size: 14px; color: #6b7280; margin-top: 5px; }  
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }  
                        th { background-color: #2563eb; color: white; padding: 12px; text-align: right; }  
                        td { padding: 12px; }  
                        tr:nth-child(even) { background-color: #f9fafb; }  
                        .star-box { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 10px; padding: 15px; margin: 20px 0; text-align: center; }  
                    </style>  
                </head>  
                <body>  
                    <div class="header">  
                        <h1>๐ ุชูุฑูุฑ ุงูุณููู ุงููููุฒ ${texts.forStudent}</h1>  
                        <h2 style="color: #059669; font-size: 22px; margin: 10px 0;">${studentName} ${starBadge}</h2>  
                        <p style="color: #6b7280;">ุงููุตู: ${behaviors[0].class}</p>  
                    </div>  
                    
                    ${totalPoints >= 20 ? `  
                    <div class="star-box">  
                        <span style="font-size: 24px;">โญ</span>  
                        <span style="font-size: 18px; color: #92400e; font-weight: bold;">ุญุงุตู ุนูู ุดุงุฑุฉ ุงูุชููุฒ</span>  
                        <span style="font-size: 24px;">โญ</span>  
                    </div>  
                    ` : ''}  
                    
                    <div class="summary">  
                        <h3 style="text-align: center; color: #1e40af; margin-bottom: 15px;">ุงูููุฎุต ุงูุฅุญุตุงุฆู</h3>  
                        <div class="summary-grid">  
                            <div class="summary-item">  
                                <div class="summary-value">${behaviors.length}</div>  
                                <div class="summary-label">ุฅุฌูุงูู ุงูุณููููุงุช</div>  
                            </div>  
                            <div class="summary-item">  
                                <div class="summary-value">+${totalPoints}</div>  
                                <div class="summary-label">ุฅุฌูุงูู ุงูููุงุท</div>  
                            </div>  
                            <div class="summary-item">  
                                <div class="summary-value">${(totalPoints / behaviors.length).toFixed(1)}</div>  
                                <div class="summary-label">ูุชูุณุท ุงูููุงุท</div>  
                            </div>  
                        </div>  
                    </div>  
                    
                    <h3 style="color: #1e40af; margin-top: 30px;">ุชูุงุตูู ุงูุณููููุงุช ุงููุณุฌูุฉ:</h3>  
                    <table>  
                        <thead>  
                            <tr>  
                                <th style="text-align: center; width: 50px;">#</th>  
                                <th style="width: 120px;">ุงูุชุงุฑูุฎ</th>  
                                <th>ููุน ุงูุณููู</th>  
                                <th style="text-align: center; width: 100px;">ุงูููุงุท</th>  
                                <th style="width: 150px;">ุงูุฑุงุตุฏ</th>  
                            </tr>  
                        </thead>  
                        <tbody>${tableRows}</tbody>  
                    </table>  
                    
                    <div style="margin-top: 50px; text-align: center; color: #6b7280; font-size: 14px;">  
                        <p>ุชู ุฅูุดุงุก ุงูุชูุฑูุฑ ุจุชุงุฑูุฎ: ${new Date().toLocaleDateString('ar-SA')}</p>  
                    </div>  
                </body>  
                </html>  
            `;  
            
            const printWindow = window.open('', '_blank');  
            printWindow.document.write(reportHTML);  
            printWindow.document.close();  
            setTimeout(() => printWindow.print(), 500);  
        }  

        // โจ MODIFIED: ุงุณุชุฎุฏุงู ุงููุตูุต ุงูุฏููุงููููุฉ ูุฅุถุงูุฉ ุดุงุฑุฉ ุงููุฌูุฉ  
        function generateClassReport(className, behaviors) {  
            const texts = GENDER_TEXTS[getSchoolType()];  
            
            const studentGroups = {};  
            behaviors.forEach(b => {  
                if (!studentGroups[b.student]) {  
                    studentGroups[b.student] = [];  
                }  
                studentGroups[b.student].push(b);  
            });  
            
            let studentsRows = '';  
            Object.entries(studentGroups)  
                .sort((a, b) => {  
                    const pointsA = a[1].reduce((sum, beh) => {  
                        const bt = typeof beh.behaviorType === 'string' ? JSON.parse(beh.behaviorType) : beh.behaviorType;  
                        return sum + (bt.points || 0);  
                    }, 0);  
                    const pointsB = b[1].reduce((sum, beh) => {  
                        const bt = typeof beh.behaviorType === 'string' ? JSON.parse(beh.behaviorType) : beh.behaviorType;  
                        return sum + (bt.points || 0);  
                    }, 0);  
                    return pointsB - pointsA;  
                })  
                .forEach(([student, studentBehaviors], index) => {  
                    const totalPoints = studentBehaviors.reduce((sum, b) => {  
                        const bt = typeof b.behaviorType === 'string' ? JSON.parse(b.behaviorType) : b.behaviorType;  
                        return sum + (bt.points || 0);  
                    }, 0);  
                    
                    // โจ NEW: ุฅุถุงูุฉ ุดุงุฑุฉ ุงููุฌูุฉ  
                    const starBadge = totalPoints >= 20 ? ' โญ' : '';  
                    
                    studentsRows += `  
                        <tr style="border-bottom: 1px solid #e5e7eb;">  
                            <td style="padding: 12px; text-align: center;">${index + 1}</td>  
                            <td style="padding: 12px; font-weight: bold;">${student}${starBadge}</td>  
                            <td style="padding: 12px; text-align: center;">${studentBehaviors.length}</td>  
                            <td style="padding: 12px; text-align: center; font-weight: bold; color: #059669;">+${totalPoints}</td>  
                        </tr>  
                    `;  
                });  
            
            const totalPoints = behaviors.reduce((sum, b) => {  
                const bt = typeof b.behaviorType === 'string' ? JSON.parse(b.behaviorType) : b.behaviorType;  
                return sum + (bt.points || 0);  
            }, 0);  
            
            const reportHTML = `  
                <!DOCTYPE html>  
                <html lang="ar" dir="rtl">  
                <head>  
                    <meta charset="UTF-8">  
                    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">  
                    <style>  
                        body { font-family: 'Tajawal', sans-serif; padding: 40px; }  
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #2563eb; padding-bottom: 20px; }  
                        .header h1 { color: #1e40af; font-size: 28px; margin: 10px 0; }  
                        .summary { background: #f0fdf4; border: 2px solid #22c55e; padding: 20px; border-radius: 10px; margin: 20px 0; }  
                        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px; }  
                        .summary-item { text-align: center; background: white; padding: 15px; border-radius: 8px; }  
                        .summary-value { font-size: 28px; font-weight: bold; color: #059669; }  
                        .summary-label { font-size: 14px; color: #6b7280; margin-top: 5px; }  
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }  
                        th { background-color: #2563eb; color: white; padding: 12px; text-align: right; }  
                        td { padding: 12px; }  
                        tr:nth-child(even) { background-color: #f9fafb; }  
                    </style>  
                </head>  
                <body>  
                    <div class="header">  
                        <h1>๐ ุชูุฑูุฑ ุงูุณููู ุงููููุฒ ูููุตู</h1>  
                        <h2 style="color: #059669; font-size: 22px; margin: 10px 0;">${className}</h2>  
                    </div>  
                    
                    <div class="summary">  
                        <h3 style="text-align: center; color: #1e40af; margin-bottom: 15px;">ุงูููุฎุต ุงูุฅุญุตุงุฆู</h3>  
                        <div class="summary-grid">  
                            <div class="summary-item">  
                                <div class="summary-value">${Object.keys(studentGroups).length}</div>  
                                <div class="summary-label">${texts.distinguishedStudentsCount}</div>  
                            </div>  
                            <div class="summary-item">  
                                <div class="summary-value">${behaviors.length}</div>  
                                <div class="summary-label">ุฅุฌูุงูู ุงูุณููููุงุช</div>  
                            </div>  
                            <div class="summary-item">  
                                <div class="summary-value">+${totalPoints}</div>  
                                <div class="summary-label">ุฅุฌูุงูู ุงูููุงุท</div>  
                            </div>  
                        </div>  
                    </div>  
                    
                    <h3 style="color: #1e40af; margin-top: 30px;">ุชุฑุชูุจ ${texts.students} ุญุณุจ ุงูุชููุฒ:</h3>  
                    <table>  
                        <thead>  
                            <tr>  
                                <th style="text-align: center; width: 50px;">ุงูุชุฑุชูุจ</th>  
                                <th>ุงุณู ${texts.student}</th>  
                                <th style="text-align: center; width: 150px;">ุนุฏุฏ ุงูุณููููุงุช</th>  
                                <th style="text-align: center; width: 150px;">ุฅุฌูุงูู ุงูููุงุท</th>  
                            </tr>  
                                                </thead>
                        <tbody>${studentsRows}</tbody>
                    </table>
                    
                    <div style="margin-top: 50px; text-align: center; color: #6b7280; font-size: 14px;">
                        <p>ุชู ุฅูุดุงุก ุงูุชูุฑูุฑ ุจุชุงุฑูุฎ: ${new Date().toLocaleDateString('ar-SA')}</p>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(reportHTML);
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 500);
        }

        function printAllOperations() {
            const behaviors = JSON.parse(localStorage.getItem(STORAGE_KEYS.BEHAVIORS) || '[]');
            const texts = GENDER_TEXTS[getSchoolType()];
            const schoolName = document.getElementById('schoolNameInput').value || 'ุงููุฏุฑุณุฉ';
            
            if (behaviors.length === 0) {
                alert('ูุง ุชูุฌุฏ ุณููููุงุช ูุณุฌูุฉ ููุทุจุงุนุฉ');
                return;
            }
            
            // Sort by date
            behaviors.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            
            let tableRows = '';
            behaviors.forEach((b, index) => {
                const behaviorType = typeof b.behaviorType === 'string' 
                    ? JSON.parse(b.behaviorType) 
                    : b.behaviorType;
                
                // โจ NEW: ุงูุชุญูู ูู ุดุงุฑุฉ ุงููุฌูุฉ
                const totalPoints = getStudentTotalPoints(b.student, behaviors);
                const starBadge = totalPoints >= 20 ? ' โญ' : '';
                
                tableRows += `
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 10px; text-align: center;">${index + 1}</td>
                        <td style="padding: 10px;">${b.date}</td>
                        <td style="padding: 10px;">${b.class}</td>
                        <td style="padding: 10px; font-weight: bold;">${b.student}${starBadge}</td>
                        <td style="padding: 10px; font-size: 13px;">${behaviorType.name}</td>
                        <td style="padding: 10px; text-align: center; font-weight: bold; color: #059669;">+${behaviorType.points}</td>
                        <td style="padding: 10px; font-size: 13px;">${b.sender}</td>
                    </tr>
                `;
            });
            
            // Calculate totals
            const totalPoints = behaviors.reduce((sum, b) => {
                const bt = typeof b.behaviorType === 'string' ? JSON.parse(b.behaviorType) : b.behaviorType;
                return sum + (bt.points || 0);
            }, 0);
            
            const uniqueStudents = new Set(behaviors.map(b => b.student)).size;
            const starStudentsCount = getStarStudents().length;
            
            const reportHTML = `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Tajawal', sans-serif; padding: 30px; font-size: 14px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #2563eb; padding-bottom: 20px; }
                        .header h1 { color: #1e40af; font-size: 26px; margin: 10px 0; }
                        .summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
                        .summary-item { background: #f0fdf4; border: 2px solid #22c55e; padding: 15px; border-radius: 10px; text-align: center; }
                        .summary-item.star { background: linear-gradient(135deg, #fef3c7, #fde68a); border-color: #f59e0b; }
                        .summary-value { font-size: 24px; font-weight: bold; color: #059669; }
                        .summary-item.star .summary-value { color: #d97706; }
                        .summary-label { font-size: 12px; color: #6b7280; margin-top: 5px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th { background-color: #2563eb; color: white; padding: 10px; text-align: right; font-size: 13px; }
                        td { padding: 10px; font-size: 13px; }
                        tr:nth-child(even) { background-color: #f9fafb; }
                        @media print { body { padding: 15px; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>๐ ุงูุชูุฑูุฑ ุงูุดุงูู ููุณููู ุงููููุฒ</h1>
                        <h2 style="color: #059669; font-size: 20px; margin: 10px 0;">${schoolName}</h2>
                        <p style="color: #6b7280;">ุชุงุฑูุฎ ุงูุชูุฑูุฑ: ${new Date().toLocaleDateString('ar-SA')}</p>
                    </div>
                    
                    <div class="summary">
                        <div class="summary-item">
                            <div class="summary-value">${behaviors.length}</div>
                            <div class="summary-label">ุฅุฌูุงูู ุงูุณููููุงุช</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">${uniqueStudents}</div>
                            <div class="summary-label">${texts.distinguishedStudentsCount}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">+${totalPoints}</div>
                            <div class="summary-label">ุฅุฌูุงูู ุงูููุงุท</div>
                        </div>
                        <div class="summary-item star">
                            <div class="summary-value">โญ ${starStudentsCount}</div>
                            <div class="summary-label">ุญุงุตููู ุนูู 20+ ุฏุฑุฌุฉ</div>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th style="text-align: center; width: 40px;">#</th>
                                <th style="width: 100px;">ุงูุชุงุฑูุฎ</th>
                                <th style="width: 120px;">ุงููุตู</th>
                                <th>${texts.student}</th>
                                <th>ููุน ุงูุณููู</th>
                                <th style="text-align: center; width: 70px;">ุงูููุงุท</th>
                                <th style="width: 120px;">ุงูุฑุงุตุฏ</th>
                            </tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                    
                    <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                        <div style="display: flex; justify-content: space-around; text-align: center;">
                            <div>
                                <p style="color: #6b7280; margin-bottom: 40px;">ุชูููุน ${texts.counselor}</p>
                                <p>________________</p>
                            </div>
                            <div>
                                <p style="color: #6b7280; margin-bottom: 40px;">ุชูููุน ${texts.principal}
                                <p>________________</p>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(reportHTML);
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 500);
        }

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
//                    BACKUP & RESTORE (ูุญุฏูุซ ูุน ุงูุฏูุฌ ุงูุฐูู)
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

function createBackup() {
    const backupData = {
        version: '2.0',
        createdAt: new Date().toISOString(),
        createdAtHijri: new Date().toLocaleDateString('ar-SA'),
        schoolName: document.getElementById('schoolNameInput').value || '',
        schoolType: getSchoolType(),
        students: localStorage.getItem(STORAGE_KEYS.STUDENTS) || '{}',
        studentsDetails: localStorage.getItem(STORAGE_KEYS.STUDENTS_DETAILS) || '[]',
        behaviors: localStorage.getItem(STORAGE_KEYS.BEHAVIORS) || '[]'
    };
    
    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `backup_distinguished_behavior_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert('โ ุชู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ');
}

function showRestoreBackupDialog() {
    document.getElementById('restoreBackupDialog').style.display = 'block';
    document.getElementById('backupPreview').classList.add('hidden');
    document.getElementById('backupFile').value = '';
    // ุชุญุฏูุฏ ุงูุงุณุชุจุฏุงู ูุฎูุงุฑ ุงูุชุฑุงุถู
    document.querySelector('input[value="replace"]').checked = true;
    updateRestoreOptionStyle();
}

function closeRestoreBackupDialog() {
    document.getElementById('restoreBackupDialog').style.display = 'none';
    document.getElementById('backupFile').value = '';
    document.getElementById('backupPreview').classList.add('hidden');
}

function updateRestoreOptionStyle() {
    const replaceOption = document.getElementById('replaceOption');
    const mergeOption = document.getElementById('mergeOption');
    const warning = document.getElementById('restoreWarning');
    const selectedMode = document.querySelector('input[name="restoreMode"]:checked').value;
    
    // ุฅุฒุงูุฉ ุงูุชูุณููุงุช ุงูุณุงุจูุฉ
    replaceOption.classList.remove('selected-replace', 'selected-merge');
    mergeOption.classList.remove('selected-replace', 'selected-merge');
    
    if (selectedMode === 'replace') {
        replaceOption.classList.add('selected-replace');
        warning.innerHTML = '<p class="text-sm text-red-700"><strong>โ๏ธ ุชุญุฐูุฑ:</strong> ุณูุชู ุญุฐู ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ ูุงุณุชุจุฏุงููุง!</p>';
        warning.className = 'bg-red-50 border-r-4 border-red-500 p-3 mb-4 rounded';
    } else {
        mergeOption.classList.add('selected-merge');
        warning.innerHTML = '<p class="text-sm text-green-700"><strong>โ ููุงุญุธุฉ:</strong> ุณูุชู ุฅุถุงูุฉ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ ููุท ุฏูู ุญุฐู ุงูููุฌูุฏุฉุ ูุน ุชุฌูุจ ุงูุชูุฑุงุฑุงุช.</p>';
        warning.className = 'bg-green-50 border-r-4 border-green-500 p-3 mb-4 rounded';
    }
}

function previewBackupFile() {
    const fileInput = document.getElementById('backupFile');
    const previewDiv = document.getElementById('backupPreview');
    const previewContent = document.getElementById('backupPreviewContent');
    
    if (!fileInput.files || fileInput.files.length === 0) {
        previewDiv.classList.add('hidden');
        return;
    }
    
    const file = fileInput.files[0];
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            const students = JSON.parse(data.students || '{}');
            const behaviors = JSON.parse(data.behaviors || '[]');
            
            let studentCount = 0;
            Object.values(students).forEach(cls => {
                studentCount += cls.length;
            });
            
            previewContent.innerHTML = `
                <div class="grid grid-cols-2 gap-2">
                    <div>๐ ุชุงุฑูุฎ ุงููุณุฎุฉ:</div>
                    <div><strong>${data.createdAtHijri || 'ุบูุฑ ูุญุฏุฏ'}</strong></div>
                    <div>๐ซ ุงููุฏุฑุณุฉ:</div>
                    <div><strong>${data.schoolName || 'ุบูุฑ ูุญุฏุฏ'}</strong></div>
                    <div>๐ ุนุฏุฏ ุงููุตูู:</div>
                    <div><strong>${Object.keys(students).length}</strong></div>
                    <div>๐จโ๐ ุนุฏุฏ ุงูุทูุงุจ:</div>
                    <div><strong>${studentCount}</strong></div>
                    <div>โญ ุณุฌูุงุช ุงูุณููู:</div>
                    <div><strong>${behaviors.length}</strong></div>
                </div>
            `;
            previewDiv.classList.remove('hidden');
        } catch (error) {
            previewContent.innerHTML = '<span class="text-red-600">โ ููู ุบูุฑ ุตุงูุญ</span>';
            previewDiv.classList.remove('hidden');
        }
    };
    
    reader.readAsText(file);
}

function restoreBackup() {
    const fileInput = document.getElementById('backupFile');
    const restoreMode = document.querySelector('input[name="restoreMode"]:checked').value;
    
    if (!fileInput.files || fileInput.files.length === 0) {
        alert('โ๏ธ ูุฑุฌู ุงุฎุชูุงุฑ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ');
        return;
    }
    
    const file = fileInput.files[0];
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const backupData = JSON.parse(e.target.result);
            
            // Validate backup format
            if (!backupData.students || !backupData.behaviors) {
                alert('โ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุบูุฑ ุตุงูุญ');
                return;
            }
            
            if (restoreMode === 'replace') {
                // === ุงูุงุณุชุจุฏุงู ุงููุงูู ===
                performFullReplace(backupData);
            } else {
                // === ุงูุฏูุฌ ุงูุฐูู ===
                performSmartMerge(backupData);
            }
            
        } catch (error) {
            console.error('ุฎุทุฃ:', error);
            alert('โ ุฎุทุฃ ูู ูุฑุงุกุฉ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ');
        }
    };
    
    reader.readAsText(file);
}

function performFullReplace(backupData) {
    // Restore data
    localStorage.setItem(STORAGE_KEYS.STUDENTS, backupData.students);
    localStorage.setItem(STORAGE_KEYS.BEHAVIORS, backupData.behaviors);
    
    if (backupData.studentsDetails) {
        localStorage.setItem(STORAGE_KEYS.STUDENTS_DETAILS, backupData.studentsDetails);
    }
    
    if (backupData.schoolName) {
        localStorage.setItem(STORAGE_KEYS.SCHOOL_NAME, backupData.schoolName);
        document.getElementById('schoolNameInput').value = backupData.schoolName;
    }
    
    if (backupData.schoolType) {
        localStorage.setItem(STORAGE_KEYS.SCHOOL_TYPE, backupData.schoolType);
        document.getElementById('schoolTypeSelect').value = backupData.schoolType;
        updateAllGenderTexts();
    }
    
    // Reload data
    studentsByClass = JSON.parse(backupData.students);
    populateClasses();
    updateAllStatistics();
    
    closeRestoreBackupDialog();
    alert('โ ุชู ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ (ุงุณุชุจุฏุงู ูุงูู)');
}

function performSmartMerge(backupData) {
    // === ุฌูุจ ุงูุจูุงูุงุช ุงูุญุงููุฉ ===
    const currentStudents = JSON.parse(localStorage.getItem(STORAGE_KEYS.STUDENTS) || '{}');
    const currentBehaviors = JSON.parse(localStorage.getItem(STORAGE_KEYS.BEHAVIORS) || '[]');
    const currentDetails = JSON.parse(localStorage.getItem(STORAGE_KEYS.STUDENTS_DETAILS) || '[]');
    
    // === ุฌูุจ ุงูุจูุงูุงุช ูู ุงูููู ===
    const newStudents = JSON.parse(backupData.students || '{}');
    const newBehaviors = JSON.parse(backupData.behaviors || '[]');
    const newDetails = JSON.parse(backupData.studentsDetails || '[]');
    
    // === ูุชุบูุฑุงุช ุงูุฅุญุตุงุฆูุงุช ===
    let addedClasses = 0;
    let addedStudents = 0;
    let addedBehaviors = 0;
    let skippedBehaviors = 0;
    let duplicateBehaviors = [];
    
    // === 1. ุฏูุฌ ุงูุทูุงุจ ุญุณุจ ุงููุตูู ===
    for (const className in newStudents) {
        if (!currentStudents[className]) {
            // ูุตู ุฌุฏูุฏ - ุฅุถุงูุฉ ูุงููุฉ
            currentStudents[className] = newStudents[className];
            addedClasses++;
            addedStudents += newStudents[className].length;
        } else {
            // ูุตู ููุฌูุฏ - ุฅุถุงูุฉ ุงูุทูุงุจ ุงูุฌุฏุฏ ููุท
            const currentNames = currentStudents[className].map(s => s.trim().toLowerCase());
            for (const student of newStudents[className]) {
                if (!currentNames.includes(student.trim().toLowerCase())) {
                    currentStudents[className].push(student);
                    addedStudents++;
                }
            }
        }
    }
    
    // === 2. ุฏูุฌ ุณุฌูุงุช ุงูุณููู ===
    for (const newRecord of newBehaviors) {
        // ุฅูุดุงุก ููุชุงุญ ูุฑูุฏ ููููุงุฑูุฉ (ุงูุทุงูุจ + ุงูุณููู + ุงูุชุงุฑูุฎ)
        const recordKey = `${newRecord.studentName || newRecord.student}_${newRecord.behaviorType || newRecord.type}_${newRecord.date}`;
        
        // ุงูุจุญุซ ุนู ุชูุฑุงุฑ
        const isDuplicate = currentBehaviors.some(current => {
            const currentKey = `${current.studentName || current.student}_${current.behaviorType || current.type}_${current.date}`;
            return currentKey === recordKey;
        });
        
        if (isDuplicate) {
            skippedBehaviors++;
            duplicateBehaviors.push({
                student: newRecord.studentName || newRecord.student,
                behavior: newRecord.behaviorType || newRecord.type,
                date: newRecord.date
            });
        } else {
            currentBehaviors.push(newRecord);
            addedBehaviors++;
        }
    }
    
    // === 3. ุฏูุฌ ุชูุงุตูู ุงูุทูุงุจ ===
    for (const detail of newDetails) {
        const exists = currentDetails.some(d => 
            d.name === detail.name && d.className === detail.className
        );
        if (!exists) {
            currentDetails.push(detail);
        }
    }
    
    // === 4. ุญูุธ ุงูุจูุงูุงุช ุงููุฏูุฌุฉ ===
    localStorage.setItem(STORAGE_KEYS.STUDENTS, JSON.stringify(currentStudents));
    localStorage.setItem(STORAGE_KEYS.BEHAVIORS, JSON.stringify(currentBehaviors));
    localStorage.setItem(STORAGE_KEYS.STUDENTS_DETAILS, JSON.stringify(currentDetails));
    
    // === 5. ุชุญุฏูุซ ุงููุงุฌูุฉ ===
    studentsByClass = currentStudents;
    populateClasses();
    updateAllStatistics();
    
    closeRestoreBackupDialog();
    
    // === 6. ุนุฑุถ ุชูุฑูุฑ ุงูุฏูุฌ ===
    let report = `โ ุชู ุงูุฏูุฌ ุงูุฐูู ุจูุฌุงุญ!\n\n`;
    report += `๐ ููุฎุต ุงูุนูููุฉ:\n`;
    report += `โโโโโโโโโโโโโโโโโโโ\n`;
    report += `๐ ูุตูู ุฌุฏูุฏุฉ: ${addedClasses}\n`;
    report += `๐จโ๐ ุทูุงุจ ุฌุฏุฏ: ${addedStudents}\n`;
    report += `โญ ุณุฌูุงุช ุณููู ุฌุฏูุฏุฉ: ${addedBehaviors}\n`;
    
    if (skippedBehaviors > 0) {
        report += `\nโ๏ธ ุณุฌูุงุช ููุฑุฑุฉ ุชู ุชุฌุงูููุง: ${skippedBehaviors}\n`;
        report += `โโโโโโโโโโโโโโโโโโโ\n`;
        
        // ุนุฑุถ ุฃูู 5 ุชูุฑุงุฑุงุช ููุท
        const showCount = Math.min(duplicateBehaviors.length, 5);
        for (let i = 0; i < showCount; i++) {
            const dup = duplicateBehaviors[i];
            report += `โข ${dup.student} - ${dup.behavior} (${dup.date})\n`;
        }
        if (duplicateBehaviors.length > 5) {
            report += `... ู ${duplicateBehaviors.length - 5} ุณุฌูุงุช ุฃุฎุฑู\n`;
        }
    }
    
    alert(report);
}

        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        //                    MODALS MANAGEMENT
        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        
        function showFilterByStudentDialog() {
            const filterClassSelect = document.getElementById('filterClassSelect');
            filterClassSelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงููุตู --</option>';
            
            Object.keys(studentsByClass).sort().forEach(c => {
                const option = document.createElement('option');
                option.value = c;
                option.textContent = c;
                filterClassSelect.appendChild(option);
            });
            
            document.getElementById('filterStudentSelect').innerHTML = `<option value="">-- ${getGenderText('selectStudent')} --</option>`;
            
            // โจ NEW: ุฅุนุงุฏุฉ ุชุนููู ููุชุฑ ุงูุชุงุฑูุฎ
            document.getElementById('studentReportDateFrom').value = '';
            document.getElementById('studentReportDateTo').value = '';
            
            document.getElementById('filterStudentModal').style.display = 'block';
        }

        function closeFilterStudentModal() {
            document.getElementById('filterStudentModal').style.display = 'none';
        }

        function showFilterByClassDialog() {
            const filterClassOnlySelect = document.getElementById('filterClassOnlySelect');
            filterClassOnlySelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงููุตู --</option>';
            
            Object.keys(studentsByClass).sort().forEach(c => {
                const option = document.createElement('option');
                option.value = c;
                option.textContent = c;
                filterClassOnlySelect.appendChild(option);
            });
            
            // โจ NEW: ุฅุนุงุฏุฉ ุชุนููู ููุชุฑ ุงูุชุงุฑูุฎ
            document.getElementById('classReportDateFrom').value = '';
            document.getElementById('classReportDateTo').value = '';
            
            document.getElementById('filterClassModal').style.display = 'block';
        }

        function closeFilterClassModal() {
            document.getElementById('filterClassModal').style.display = 'none';
        }

        function showInfographicModal() {
            document.getElementById('infographicModal').style.display = 'block';
        }

        function closeInfographicModal() {
            document.getElementById('infographicModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };

        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        //                    UTILITY FUNCTIONS
        // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        
        function copyLink(url) {
            navigator.clipboard.writeText(url).then(() => {
                alert('โ ุชู ูุณุฎ ุงูุฑุงุจุท');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('โ ุชู ูุณุฎ ุงูุฑุงุจุท');
            });
        }

        // ๐ฑ ุฏุงูุฉ ุฅุฑุณุงู ูุงุชุณุงุจ ูุญุณููุฉ
        function sendWhatsApp(behaviorId) {
            const behaviors = JSON.parse(localStorage.getItem(STORAGE_KEYS.BEHAVIORS) || '[]');
            const behavior = behaviors.find(b => b.id === behaviorId);
            
            if (!behavior) {
                alert('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุณููู');
                return;
            }
            
            // ุงูุจุญุซ ุนู ุฑูู ุฌูุงู ุงูุทุงูุจ
            const studentsDetails = JSON.parse(localStorage.getItem(STORAGE_KEYS.STUDENTS_DETAILS) || '[]');
            const studentDetail = studentsDetails.find(s => s.name === behavior.student);
            
            const behaviorType = typeof behavior.behaviorType === 'string' 
                ? JSON.parse(behavior.behaviorType) 
                : behavior.behaviorType;
            
            const schoolName = document.getElementById('schoolNameInput').value || 'ุงููุฏุฑุณุฉ';
            const texts = GENDER_TEXTS[getSchoolType()];
            
            // ุชูููู ุงูุฑุณุงูุฉ
            const message = `๐ *ุดูุงุฏุฉ ุงูุณููู ุงููููุฒ*

๐ *${schoolName}*

๐ค *${texts.student}:* ${behavior.student}
๐ซ *ุงููุตู:* ${behavior.class}

โจ *ุงูุณููู ุงููููุฒ:*
${behaviorType.name}

โญ *ุงูููุงุท ุงูููุชุณุจุฉ:* +${behaviorType.points} ุฏุฑุฌุงุช

๐ *ุงูุชุงุฑูุฎ:* ${behavior.date}

${texts.prayerFor} ุจุฏูุงู ุงูุชูููู ูุงููุฌุงุญ ๐`;

            // ุชูุธูู ุฑูู ุงูุฌูุงู
            let phoneNumber = '';
            if (studentDetail && studentDetail.phone) {
                phoneNumber = studentDetail.phone.replace(/\D/g, '');
                // ุฅุถุงูุฉ ุฑูุฒ ุงูุณุนูุฏูุฉ ุฅุฐุง ูู ููู ููุฌูุฏุงู
                if (phoneNumber.startsWith('05')) {
                    phoneNumber = '966' + phoneNumber.substring(1);
                } else if (!phoneNumber.startsWith('966')) {
                    phoneNumber = '966' + phoneNumber;
                }
            }
            
            // ูุชุญ ูุงุชุณุงุจ
            const encodedMessage = encodeURIComponent(message);
            
            if (phoneNumber) {
                window.open(`https://wa.me/${phoneNumber}?text=${encodedMessage}`, '_blank');
            } else {
                // ูุชุญ ูุงุชุณุงุจ ุจุฏูู ุฑูู (ูููุณุฎ ูุงููุตู)
                window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
            }
        }

        // ๐ฑ ุฏุงูุฉ ุฅุฑุณุงู ูุงุชุณุงุจ ูุน ุฅุฏุฎุงู ุงูุฑูู ูุฏููุงู
        function sendWhatsAppManual(behaviorId) {
            const phone = prompt('ุฃุฏุฎู ุฑูู ุงูุฌูุงู (ูุซุงู: 0501234567):');
            if (!phone) return;
            
            const behaviors = JSON.parse(localStorage.getItem(STORAGE_KEYS.BEHAVIORS) || '[]');
            const behavior = behaviors.find(b => b.id === behaviorId);
            
            if (!behavior) {
                alert('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุณููู');
                return;
            }
            
            const behaviorType = typeof behavior.behaviorType === 'string' 
                ? JSON.parse(behavior.behaviorType) 
                : behavior.behaviorType;
            
            const schoolName = document.getElementById('schoolNameInput').value || 'ุงููุฏุฑุณุฉ';
            const texts = GENDER_TEXTS[getSchoolType()];
            
            const message = `๐ *ุดูุงุฏุฉ ุงูุณููู ุงููููุฒ*

๐ *${schoolName}*

๐ค *${texts.student}:* ${behavior.student}
๐ซ *ุงููุตู:* ${behavior.class}

โจ *ุงูุณููู ุงููููุฒ:*
${behaviorType.name}

โญ *ุงูููุงุท ุงูููุชุณุจุฉ:* +${behaviorType.points} ุฏุฑุฌุงุช

๐ *ุงูุชุงุฑูุฎ:* ${behavior.date}

${texts.prayerFor} ุจุฏูุงู ุงูุชูููู ูุงููุฌุงุญ ๐`;

            // ุชูุธูู ุงูุฑูู
            let phoneNumber = phone.replace(/\D/g, '');
            if (phoneNumber.startsWith('05')) {
                phoneNumber = '966' + phoneNumber.substring(1);
            } else if (!phoneNumber.startsWith('966')) {
                phoneNumber = '966' + phoneNumber;
            }
            
            const encodedMessage = encodeURIComponent(message);
            window.open(`https://wa.me/${phoneNumber}?text=${encodedMessage}`, '_blank');
        }

// ุฅุฑุณุงู ูุงุชุณุงุจ ูุจุงุดุฑุฉ ุจุฏูู ุงูุญุงุฌุฉ ูุญูุธ ุงูุณููู ุฃููุงู
function sendWhatsAppDirect() {
    const selectedStudents = getSelectedStudents();
    const className = document.getElementById('classSelect').value;
    const behaviorTypeValue = document.getElementById('behaviorType').value;
    const texts = GENDER_TEXTS[getSchoolType()];
    
    // ุงูุชุญูู ูู ุงูุจูุงูุงุช
    if (!className) {
        alert('โ๏ธ ูุฑุฌู ุงุฎุชูุงุฑ ุงูุตู ูุงููุตู');
        return;
    }
    
    if (selectedStudents.length === 0) {
        alert(`โ๏ธ ูุฑุฌู ุงุฎุชูุงุฑ ${texts.student}`);
        return;
    }
    
    if (!behaviorTypeValue) {
        alert('โ๏ธ ูุฑุฌู ุงุฎุชูุงุฑ ููุน ุงูุณููู');
        return;
    }
    
    // ุงูุญุตูู ุนูู ุจูุงูุงุช ุงูุณููู
    let behaviorType = JSON.parse(behaviorTypeValue);
    if (selectedDegree === 'other') {
        const customPoints = parseInt(document.getElementById('customPoints').value);
        if (!customPoints || customPoints < 1 || customPoints > 6) {
            alert('โ๏ธ ูุฑุฌู ุฅุฏุฎุงู ุนุฏุฏ ุฏุฑุฌุงุช ุตุญูุญ (ูู 1 ุฅูู 6)');
            return;
        }
        behaviorType.points = customPoints;
    }
    
    const schoolName = document.getElementById('schoolNameInput').value || 'ุงููุฏุฑุณุฉ';
    const studentName = selectedStudents[0]; // ุฃูู ุทุงูุจ ูุญุฏุฏ
    
    // ุงูุจุญุซ ุนู ุฑูู ุงูุฌูุงู
    const studentsDetails = JSON.parse(localStorage.getItem(STORAGE_KEYS.STUDENTS_DETAILS) || '[]');
    const studentDetail = studentsDetails.find(s => s.name === studentName);
    
    // ุชูููู ุงูุฑุณุงูุฉ
    const message = `๐ *ุดูุงุฏุฉ ุงูุณููู ุงููููุฒ*
๐ *${schoolName}*
๐ค *${texts.student}:* ${studentName}
๐ซ *ุงููุตู:* ${className}
โจ *ุงูุณููู:* ${behaviorType.name}
โญ *ุงูููุงุท:* +${behaviorType.points}
๐ *ุงูุชุงุฑูุฎ:* ${new Date().toLocaleDateString('ar-SA')}
${texts.prayerFor} ุจุฏูุงู ุงูุชูููู ๐`;

    let phoneNumber = '';
    if (studentDetail && studentDetail.phone) {
        phoneNumber = studentDetail.phone.replace(/\D/g, '');
        if (phoneNumber.startsWith('05')) {
            phoneNumber = '966' + phoneNumber.substring(1);
        } else if (!phoneNumber.startsWith('966')) {
            phoneNumber = '966' + phoneNumber;
        }
    }
    
    const encodedMessage = encodeURIComponent(message);
    
    if (phoneNumber) {
        window.open(`https://wa.me/${phoneNumber}?text=${encodedMessage}`, '_blank');
    } else {
        window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
    }
}


// ุทุจุงุนุฉ ุงูุณููููุงุช ูููุชุฑุฉ ุงููููุชุฑุฉ
function printFilteredPeriod() {
    let behaviors = JSON.parse(localStorage.getItem(STORAGE_KEYS.BEHAVIORS) || '[]');
    
    if (!activeDateFilter) {
        alert('โ๏ธ ูุง ููุฌุฏ ููุชุฑ ุชุงุฑูุฎ ูุดุท');
        return;
    }
    
    // ุชุทุจูู ุงูููุชุฑ
    behaviors = filterBehaviorsByDate(behaviors, activeDateFilter.from, activeDateFilter.to);
    
    if (behaviors.length === 0) {
        alert('โ๏ธ ูุง ุชูุฌุฏ ุณููููุงุช ูู ูุฐู ุงููุชุฑุฉ');
        return;
    }
    
    const texts = GENDER_TEXTS[getSchoolType()];
    const schoolName = document.getElementById('schoolNameInput').value || 'ุงููุฏุฑุณุฉ';
    
    // ุชุฑุชูุจ ุญุณุจ ุงูุชุงุฑูุฎ
    behaviors.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
    
    // ุชุญุฏูุฏ ูุต ุงููุชุฑุฉ
    let periodText = '';
    if (activeDateFilter.fromStr && activeDateFilter.toStr) {
        periodText = `ูู ${activeDateFilter.fromStr} ุฅูู ${activeDateFilter.toStr}`;
    } else if (activeDateFilter.fromStr) {
        periodText = `ูู ${activeDateFilter.fromStr}`;
    } else {
        periodText = `ุญุชู ${activeDateFilter.toStr}`;
    }
    
    // ุฅูุดุงุก ุตููู ุงูุฌุฏูู
    let tableRows = '';
    behaviors.forEach((b, index) => {
        const behaviorType = typeof b.behaviorType === 'string' 
            ? JSON.parse(b.behaviorType) 
            : b.behaviorType;
        
        const allBehaviors = JSON.parse(localStorage.getItem(STORAGE_KEYS.BEHAVIORS) || '[]');
        const totalPoints = getStudentTotalPoints(b.student, allBehaviors);
        const starBadge = totalPoints >= 20 ? ' โญ' : '';
        
        tableRows += `
            <tr style="border-bottom: 1px solid #e5e7eb; ${index % 2 === 0 ? 'background-color: #f9fafb;' : ''}">
                <td style="padding: 10px; text-align: center;">${index + 1}</td>
                <td style="padding: 10px;">${b.date}</td>
                <td style="padding: 10px;">${b.class}</td>
                <td style="padding: 10px; font-weight: bold;">${b.student}${starBadge}</td>
                <td style="padding: 10px; font-size: 13px;">${behaviorType.name}</td>
                <td style="padding: 10px; text-align: center; font-weight: bold; color: #059669;">+${behaviorType.points}</td>
                <td style="padding: 10px; font-size: 13px;">${b.sender}</td>
            </tr>
        `;
    });
    
    // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
    const totalPoints = behaviors.reduce((sum, b) => {
        const bt = typeof b.behaviorType === 'string' ? JSON.parse(b.behaviorType) : b.behaviorType;
        return sum + (bt.points || 0);
    }, 0);
    const uniqueStudents = new Set(behaviors.map(b => b.student)).size;
    
    const reportHTML = `
        <!DOCTYPE html>
        <html lang="ar" dir="rtl">
        <head>
            <meta charset="UTF-8">
            <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
            <style>
                body { font-family: 'Tajawal', sans-serif; padding: 30px; font-size: 14px; }
                .header { text-align: center; margin-bottom: 25px; border-bottom: 3px solid #2563eb; padding-bottom: 20px; }
                .header h1 { color: #1e40af; font-size: 24px; margin: 10px 0; }
                .period-badge { background: #dbeafe; color: #1e40af; padding: 8px 16px; border-radius: 20px; display: inline-block; margin: 10px 0; font-weight: bold; }
                .summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
                .summary-item { background: #f0fdf4; border: 2px solid #22c55e; padding: 15px; border-radius: 10px; text-align: center; }
                .summary-value { font-size: 24px; font-weight: bold; color: #059669; }
                .summary-label { font-size: 12px; color: #6b7280; margin-top: 5px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th { background-color: #2563eb; color: white; padding: 10px; text-align: right; font-size: 13px; }
                @media print { body { padding: 15px; } }

/* โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ */
/* ูุธุงู ุงูุชุญุฏูุซ ุงูุชููุงุฆู */
/* โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ */
.update-notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 30px;
    border-radius: 15px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    z-index: 999999;
    text-align: center;
    min-width: 350px;
    max-width: 90%;
    animation: updateSlideDown 0.5s ease-out;
    direction: rtl;
    font-family: 'Tajawal', sans-serif;
}

@keyframes updateSlideDown {
    from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
    to { transform: translateX(-50%) translateY(0); opacity: 1; }
}

.update-notification h3 { margin: 0 0 10px 0; font-size: 20px; }
.update-notification p { margin: 0 0 15px 0; font-size: 14px; opacity: 0.9; }

.update-notification .version-info {
    background: rgba(255,255,255,0.2);
    padding: 8px 12px;
    border-radius: 5px;
    font-size: 13px;
    margin-bottom: 15px;
}

.update-notification .features-list {
    background: rgba(255,255,255,0.1);
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 15px;
    font-size: 12px;
    text-align: right;
}

.update-notification button {
    background: white;
    color: #667eea;
    border: none;
    padding: 12px 25px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    font-size: 14px;
    margin: 0 5px;
    transition: all 0.3s;
}

.update-notification button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.update-notification button.later-btn {
    background: transparent;
    color: white;
    border: 2px solid white;
}

.update-toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #10b981;
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    z-index: 999998;
    font-size: 14px;
    direction: rtl;
    animation: toastSlideIn 0.3s;
}



@keyframes toastSlideIn {
    from { transform: translateX(100px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}


/* ุฎูููุฉ ูุธููุฉ ุฎูู ุงููุงูุฐุฉ */
.update-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 999998;
    animation: fadeIn 0.3s;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes updatePopIn {
    from { 
        transform: translate(-50%, -50%) scale(0.8); 
        opacity: 0; 
    }
    to { 
        transform: translate(-50%, -50%) scale(1); 
        opacity: 1; 
    }
}

/* โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ */
/* ุชูุณูู ุฎูุงุฑุงุช ุงูุงุณุชุนุงุฏุฉ                          */
/* โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ */
.restore-option {
    border-color: #e5e7eb;
}

.restore-option.selected-replace {
    border-color: #ef4444;
    background-color: #fef2f2;
}

.restore-option.selected-merge {
    border-color: #22c55e;
    background-color: #f0fdf4;
}


            </style>
        </head>
        <body>
            <div class="header">
                <h1>๐ ุชูุฑูุฑ ุงูุณููู ุงููููุฒ</h1>
                <h2 style="color: #059669; font-size: 18px; margin: 10px 0;">${schoolName}</h2>
                <div class="period-badge">๐ ${periodText}</div>
            </div>
            
            <div class="summary">
                <div class="summary-item">
                    <div class="summary-value">${behaviors.length}</div>
                    <div class="summary-label">ุฅุฌูุงูู ุงูุณููููุงุช</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">${uniqueStudents}</div>
                    <div class="summary-label">${texts.distinguishedStudentsCount}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">+${totalPoints}</div>
                    <div class="summary-label">ุฅุฌูุงูู ุงูููุงุท</div>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th style="text-align: center; width: 40px;">#</th>
                        <th style="width: 100px;">ุงูุชุงุฑูุฎ</th>
                        <th style="width: 120px;">ุงููุตู</th>
                        <th>${texts.student}</th>
                        <th>ููุน ุงูุณููู</th>
                        <th style="text-align: center; width: 70px;">ุงูููุงุท</th>
                        <th style="width: 100px;">ุงูุฑุงุตุฏ</th>
                    </tr>
                </thead>
                <tbody>${tableRows}</tbody>
            </table>
            
            <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                <div style="display: flex; justify-content: space-around; text-align: center;">
                    <div>
                        <p style="color: #6b7280; margin-bottom: 40px;">ุชูููุน ${texts.counselor}</p>
                        <p>________________</p>
                    </div>
                    <div>
                        <p style="color: #6b7280; margin-bottom: 40px;">ุชูููุน ${texts.principal}</p>
                        <p>________________</p>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 30px; text-align: center; color: #9ca3af; font-size: 12px;">
                ุชู ุฅูุดุงุก ุงูุชูุฑูุฑ: ${new Date().toLocaleDateString('ar-SA')}
            </div>
        </body>
        </html>
    `;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(reportHTML);
    printWindow.document.close();
    setTimeout(() => printWindow.print(), 500);
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
//                    ูุธุงู ุงูุชุญุฏูุซ ุงูุชููุงุฆู
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

const CURRENT_APP_VERSION = "1.0.3";
const VERSION_FILE_URL = "https://goldenveinshq.github.io/alsuluk_almumayaz/version.json";
const UPDATE_CHECK_INTERVAL = 3 * 60 * 1000;

let updateCheckInProgress = false;

async function checkForUpdates(silent = false) {
    if (updateCheckInProgress) return;
    updateCheckInProgress = true;
    
    try {
        const timestamp = new Date().getTime();
        const response = await fetch(`${VERSION_FILE_URL}?t=${timestamp}`, {
            cache: 'no-store',
            headers: { 'Cache-Control': 'no-cache' }
        });
        
        if (!response.ok) throw new Error('ูุดู ุฌูุจ ูุนูููุงุช ุงููุณุฎุฉ');
        
        const serverVersion = await response.json();
        
        if (isNewerVersion(serverVersion.version, CURRENT_APP_VERSION)) {
            console.log('๐ ุชุญุฏูุซ ุฌุฏูุฏ:', serverVersion.version);
            if (!silent) showUpdateNotification(serverVersion);
        } else {
            console.log('โ ุงูุจุฑูุงูุฌ ูุญุฏุซ - v' + CURRENT_APP_VERSION);
        }
    } catch (error) {
        console.log('โ๏ธ ูุดู ูุญุต ุงูุชุญุฏูุซุงุช:', error.message);
    } finally {
        updateCheckInProgress = false;
    }
}

function isNewerVersion(newVer, currentVer) {
    const n = newVer.split('.').map(Number);
    const c = currentVer.split('.').map(Number);
    for (let i = 0; i < Math.max(n.length, c.length); i++) {
        if ((n[i] || 0) > (c[i] || 0)) return true;
        if ((n[i] || 0) < (c[i] || 0)) return false;
    }
    return false;
}

function showUpdateNotification(updateInfo) {
    // ุฅุฒุงูุฉ ุฃู ูุงูุฐุฉ ูุฏููุฉ
    const old = document.querySelector('.update-notification');
    if (old) old.remove();
    
    const oldBackdrop = document.querySelector('.update-backdrop');
    if (oldBackdrop) oldBackdrop.remove();
    
    let featuresHTML = '';
    if (updateInfo.features && updateInfo.features.length > 0) {
        featuresHTML = `<div class="features-list" style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 12px; text-align: right;"><strong>โจ ุงูุฌุฏูุฏ:</strong><br>${updateInfo.features.map(f => 'โข ' + f).join('<br>')}</div>`;
    }
    
    // ุฅูุดุงุก ุงูุฎูููุฉ ุงููุธููุฉ
    const backdrop = document.createElement('div');
    backdrop.className = 'update-backdrop';
    backdrop.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 999998;
        animation: fadeIn 0.3s;
    `;
    document.body.appendChild(backdrop);
    
    // ุฅูุดุงุก ูุงูุฐุฉ ุงูุชุญุฏูุซ
    const notification = document.createElement('div');
    notification.className = 'update-notification';
    
    // ุฅุถุงูุฉ Inline Styles ููุชุฃูุฏ ูู ุงูุชุทุจูู
    notification.style.cssText = `
        position: fixed !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        padding: 20px 30px !important;
        border-radius: 15px !important;
        box-shadow: 0 10px 40px rgba(0,0,0,0.4) !important;
        z-index: 999999 !important;
        text-align: center !important;
        min-width: 350px !important;
        max-width: 90% !important;
        animation: updatePopIn 0.4s ease-out !important;
        direction: rtl !important;
        font-family: 'Tajawal', sans-serif !important;
    `;
    
    notification.innerHTML = `
        <h3 style="margin: 0 0 10px 0; font-size: 20px;">๐ ููุฌุฏ ุชุญุฏูุซ ุฌุฏูุฏ!</h3>
        <div class="version-info" style="background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 5px; font-size: 13px; margin-bottom: 15px;">
            ุงูุญุงููุฉ: <strong>v${CURRENT_APP_VERSION}</strong> โ ุงูุฌุฏูุฏุฉ: <strong>v${updateInfo.version}</strong>
        </div>
        <p style="margin: 0 0 15px 0; font-size: 14px; opacity: 0.9;">${updateInfo.message || 'ุชุญุฏูุซุงุช ูุชุญุณููุงุช ุฌุฏูุฏุฉ'}</p>
        ${featuresHTML}
        <div>
            <button id="updateNowBtn" style="background: white; color: #667eea; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; margin: 0 5px; transition: all 0.3s;">๐ ุชุญุฏูุซ ุงูุขู</button>
            <button id="updateLaterBtn" style="background: transparent; color: white; border: 2px solid white; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; margin: 0 5px; transition: all 0.3s;">โฐ ูุงุญูุงู</button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // ุฑุจุท ุงูุฃุฒุฑุงุฑ ุจุนุฏ ุฅุถุงูุฉ ุงูุนูุตุฑ ููุตูุญุฉ
    document.getElementById('updateNowBtn').addEventListener('click', applyUpdate);
    document.getElementById('updateLaterBtn').addEventListener('click', dismissUpdate);
}

function applyUpdate() {
    showUpdateToast('ุฌุงุฑู ุงูุชุญุฏูุซ...', '#3b82f6');
    setTimeout(() => {
        if ('caches' in window) {
            caches.keys().then(names => names.forEach(name => caches.delete(name)));
        }
        window.location.reload(true);
    }, 1000);
}

function dismissUpdate() {
    const notification = document.querySelector('.update-notification');
    const backdrop = document.querySelector('.update-backdrop');
    
    if (notification) {
        notification.style.opacity = '0';
        notification.style.transform = 'translate(-50%, -50%) scale(0.8)';
        notification.style.transition = 'all 0.3s';
        setTimeout(() => notification.remove(), 300);
    }
    
    if (backdrop) {
        backdrop.style.opacity = '0';
        backdrop.style.transition = 'opacity 0.3s';
        setTimeout(() => backdrop.remove(), 300);
    }
    
    // ุฅุนุงุฏุฉ ุงููุญุต ุจุนุฏ 10 ุฏูุงุฆู
    setTimeout(() => checkForUpdates(false), 10 * 60 * 1000);
}

function showUpdateToast(message, color = '#10b981') {
    const old = document.querySelector('.update-toast');
    if (old) old.remove();
    const toast = document.createElement('div');
    toast.className = 'update-toast';
    toast.style.background = color;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function updateVersionBadge() {
    const badge = document.getElementById('appVersionBadge');
    if (badge) badge.textContent = 'v' + CURRENT_APP_VERSION;
}

// ุชุดุบูู ูุธุงู ุงูุชุญุฏูุซ
document.addEventListener('DOMContentLoaded', () => {
    console.log('๐ ุจุฑูุงูุฌ ุฑุตุฏ ุงูุณููู ุงููููุฒ - v' + CURRENT_APP_VERSION);
    updateVersionBadge();
    setTimeout(() => checkForUpdates(false), 5000);
    setInterval(() => checkForUpdates(false), UPDATE_CHECK_INTERVAL);
});

document.addEventListener('visibilitychange', () => {
    if (!document.hidden) setTimeout(() => checkForUpdates(true), 2000);
});

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
//                    ุณูุงุณุฉ ุงูุฎุตูุตูุฉ
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

function openPrivacyModal() {
    document.getElementById('privacyModal').style.display = 'block';
}

function closePrivacyModal() {
    document.getElementById('privacyModal').style.display = 'none';
}

    </script>
</body>
</html>

